<!doctype html><html lang=en><head><title>How to debug deadlocks in Visual Studio | Andy Hippo</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Andy Hippo"><meta name=description content="There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)"><meta name=keywords content="blog,developer,personal,visual studio,debugging,windows"><link rel=me href=https://mastodon.social/@werat><meta name=twitter:card content="summary"><meta name=twitter:title content="How to debug deadlocks in Visual Studio"><meta name=twitter:description content="There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)"><meta property="og:title" content="How to debug deadlocks in Visual Studio"><meta property="og:description" content="There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)"><meta property="og:type" content="article"><meta property="og:url" content="https://werat.dev/blog/how-to-debug-deadlocks-in-visual-studio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-17T12:21:00+01:00"><meta property="article:modified_time" content="2022-09-17T12:21:00+01:00"><link rel=canonical href=https://werat.dev/blog/how-to-debug-deadlocks-in-visual-studio/><link rel=alternate type=application/rss+xml title=werat.dev href=https://werat.dev/index.xml><link rel=icon href=/favicon.ico sizes=any><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifest.webmanifest><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.120.4"></head><body><header class=nav-header><nav><span class=nav-title><a href=/>werat.dev</a>
</span><a href=/about/>About</a>
<a href=/posts/>Blog</a>
<a href=/talks/>Talks</a></nav></header><main><article><header><h1 class=title>How to debug deadlocks in Visual Studio</h1><time class=posted-on datetime=2022-09-17T12:21:00+01:00>September 17, 2022</time></header><p>There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)</p><hr><p>Late afternoon, it&rsquo;s raining outside. Visual Studio UI is frozen and doesn&rsquo;t respond to anything. Windows is suggesting to give up and send the diagnostics to Microsoft. The only way out seems to be killing the application and starting all over again. But before doing that, let&rsquo;s try to figure out what exactly went wrong on this nice day.</p><p>Despite people complaining about Visual Studio being slow and bloaty, it doesn&rsquo;t really freeze that often on its own<sup>[citation needed]</sup>. It&rsquo;s a lot more likely that one of the extensions is misbehaving. Given that in my case Visual Studio froze in the middle of the debug session, I&rsquo;m fairly confident I&rsquo;ve been betrayed by my own extension <a href=https://github.com/googlestadia/vsi-lldb>Stadia for Visual Studio</a>.</p><p>Let&rsquo;s spin up another Visual Studio, attach the debugger to the frozen one and hit &ldquo;Break All&rdquo; (the pause button):</p><p><img src=1.png alt=image width=1260 height=670></p><p>Well, well, well. What do we have here? The main thread (also known as the UI thread) is blocked trying to acquire a lock (highlighted in green on the screenshot). No wonder the application is not responding &ndash; all the input processing is happening on the main thread. If it&rsquo;s stuck, the whole UI is stuck as well.</p><p>Visual Studio provides another hint here, which indicates a deadlock problem &ndash; the line highlighted in gray was found in another thread&rsquo;s call stack. This means there&rsquo;s another thread which entered <code>GetOrCreate()</code> method, took the lock on <code>cache</code> and then proceeded to invoking the <code>ModuleAdded</code> event handlers. How do we figure out why the thread is blocked here? Who else is holding the lock? Easy! Let&rsquo;s take a look at the call stack:</p><p><img src=2.png alt=image width=1141 height=479></p><p>The call stack immediately tells us that the current thread is waiting for a lock, which is already acquired by another thread &ndash; thread <code>33756</code> in this case. Since the whole application is currently stopped, we can just switch to that thread and see what is happening there:</p><p><img src=3.png alt=image width=1257 height=670></p><p>Okay, this thread is synchronously waiting for an asynchronous task. Let&rsquo;s take a look at its call stack:</p><p><img src=4.png alt=image width=1177 height=591></p><p>First thing we see here is that indeed this thread went through the <code>GetOrCreate</code> method. It took the lock on <code>cache</code> and never released it, that&rsquo;s why the main thread is stuck. Now we need to figure out why this worker thread is stuck. The call stack conveniently shows us that we&rsquo;re waiting for another <code>Task</code> to complete - task <code>12369579</code>.</p><p>Visual Studio provides an easy way to see which tasks are currently being executed and how they depend on each other &ndash; the Tasks Window. Let&rsquo;s switch there and see what it looks like for the current thread:</p><p><img src=5.png alt=image width=1179 height=181></p><p>This confirms what we saw in the call stack &ndash; current thread (which corresponds to task <code>12369578</code>) is waiting for task <code>12369579</code> to complete. The hover popup from the <code>Location</code> column gives even more information:</p><p><img src=6.png alt=image width=1213 height=654></p><p>These are all the tasks in the waiting chain: <code>12369578</code> waits for <code>12369579</code>, which waits for <code>12370519</code>, which waits for <code>12370517</code>. Let&rsquo;s switch the the last one, task <code>12370517</code>:</p><p><img src=7.png alt=image width=1229 height=788></p><p>Booyah! The task is trying to switch the main thread (i.e. to continue executing on the <strong>main</strong> thread instead of some random worker thread), which is typically done when you need to access some UI elements or, in this case, call certain Visual Studio APIs. But the main thread is blocked! Here&rsquo;s a summary in terms of call sequences:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#177500>// Main Thread</span>
</span></span><span style=display:flex><span><span style=color:#000>DebugAsyncStackFrame</span>.<span style=color:#000>GetInfo</span>
</span></span><span style=display:flex><span><span style=color:#000>↪️</span> <span style=color:#000>AD7FrameInfoCreator</span>.<span style=color:#000>Create</span>
</span></span><span style=display:flex><span>  <span style=color:#000>↪️</span> <span style=color:#000>DebugModuleCache</span>.<span style=color:#000>GetOrCreate</span>
</span></span><span style=display:flex><span>    <span style=color:#000>↪️</span> <span style=color:#a90d91>lock</span>(<span style=color:#000>cache</span>) -- <span style=color:#000>waiting</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// Worker Thread</span>
</span></span><span style=display:flex><span><span style=color:#000>LldbEventManager</span>.<span style=color:#000>LldbListenerOnModulesChanged</span>
</span></span><span style=display:flex><span><span style=color:#000>↪️</span> <span style=color:#000>DebugModuleCache</span>.<span style=color:#000>GetOrCreate</span>
</span></span><span style=display:flex><span>  <span style=color:#000>↪️</span> <span style=color:#a90d91>lock</span>(<span style=color:#000>cache</span>) -- <span style=color:#000>acquired</span>
</span></span><span style=display:flex><span>    <span style=color:#000>↪️</span> <span style=color:#000>ModuleAdded</span>.<span style=color:#000>Invoke</span>
</span></span><span style=display:flex><span>      <span style=color:#000>↪️</span> <span style=color:#000>DebugEngineHandler</span>.<span style=color:#000>SendEventAsync</span>
</span></span><span style=display:flex><span>        <span style=color:#000>↪️</span> <span style=color:#a90d91>await</span> <span style=color:#000>_taskContext</span>.<span style=color:#000>Factory</span>.<span style=color:#000>SwitchToMainThreadAsync</span>()
</span></span><span style=display:flex><span>           <span style=color:#000>↖️</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// Deadlock, main thread is waiting for lock(cache)</span>
</span></span></code></pre></div><p>Fixing deadlocks can be tricky and it always depends on the logic of your application. Here&rsquo;s the solution I&rsquo;ve implemented for this one &ndash; <a href=https://github.com/googlestadia/vsi-lldb/commit/e66a6b5e7df879b82e535884bad3ae148b33d68c>e66a6b5e</a>. The &ldquo;obvious&rdquo; thing to do is typically move some operations outside of the critical section, but it&rsquo;s always worth looking deeper &ndash; do I even need this lock? do I have to switch to main thread to perform some operation? Taking a holistic overview often leads to better design improvements.</p><hr><p>Discuss this article on <a href=https://lobste.rs/s/qtdvpn/how_debug_deadlocks_visual_studio>lobste.rs</a></p><hr></article></main><footer>© 2017 - 2023 <a href=mailto:weratt@gmail.com>Andy Hippo</a>
(<a href=https://twitter.com/werat>@werat</a>)
· Licensed under <a href=https://github.com/werat/werat.github.io/blob/main/LICENSE>MIT</a></footer><script data-goatcounter=https://werat-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>