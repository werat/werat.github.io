<!doctype html><html lang=en><head><title>How to debug deadlocks in Visual Studio · Reboot and Shine</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Andy Hippo"><meta name=description content="There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to debug deadlocks in Visual Studio"><meta name=twitter:description content="There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)"><meta property="og:title" content="How to debug deadlocks in Visual Studio"><meta property="og:description" content="There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)"><meta property="og:type" content="article"><meta property="og:url" content="https://werat.dev/blog/how-to-debug-deadlocks-in-visual-studio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-17T12:21:00+01:00"><meta property="article:modified_time" content="2022-09-17T12:21:00+01:00"><link rel=canonical href=https://werat.dev/blog/how-to-debug-deadlocks-in-visual-studio/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.min.3a66cc83b990cd6dcf6ee255edb3772f393c19e0bcd1c29c79805d1de9fa3841.css integrity="sha256-OmbMg7mQzW3PbuJV7bN3Lzk8GeC80cKceYBdHen6OEE=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/img/logo-avatar-32.png sizes=32x32><link rel=icon type=image/png href=/img/logo-avatar-16.png sizes=16x16><link rel=apple-touch-icon href=/img/logo-avatar.png><link rel=apple-touch-icon sizes=180x180 href=/img/logo-avatar.png><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.104.3"></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Reboot and Shine</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/talks/>Talks</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://werat.dev/blog/how-to-debug-deadlocks-in-visual-studio/>How to debug deadlocks in Visual Studio</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2022-09-17T12:21:00+01:00>September 17, 2022</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/visual-studio/>visual studio</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/debugging/>debugging</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/windows/>windows</a></span></div></div></header><div><p>There has been lots of discussions recently about the usefulness of debuggers (on Twitter/Reddit and probably other platforms). Some people brag about never using/needing one and some people can&rsquo;t imagine their life without stepping through the code line by line. I&rsquo;m both of these people at different times, so I&rsquo;m not going to judge anyone. Instead, let me share a short debugging story and you can decide for yourself :)</p><hr><p>Late afternoon, it&rsquo;s raining outside. Visual Studio UI is frozen and doesn&rsquo;t respond to anything. Windows is suggesting to give up and send the diagnostics to Microsoft. The only way out seems to be killing the application and starting all over again. But before doing that, let&rsquo;s try to figure out what exactly went wrong on this nice day.</p><p>Despite people complaining about Visual Studio being slow and bloaty, it doesn&rsquo;t really freeze that often on its own<sup>[citation needed]</sup>. It&rsquo;s a lot more likely that one of the extensions is misbehaving. Given that in my case Visual Studio froze in the middle of the debug session, I&rsquo;m fairly confident I&rsquo;ve been betrayed by my own extension <a href=https://github.com/googlestadia/vsi-lldb>Stadia for Visual Studio</a>.</p><p>Let&rsquo;s spin up another Visual Studio, attach the debugger to the frozen one and hit &ldquo;Break All&rdquo; (the pause button):</p><p><img src=1.png alt=image></p><p>Well, well, well. What do we have here? The main thread (also known as the UI thread) is blocked trying to acquire a lock (highlighted in green on the screenshot). No wonder the application is not responding &ndash; all the input processing is happening on the main thread. If it&rsquo;s stuck, the whole UI is stuck as well.</p><p>Visual Studio provides another hint here, which indicates a deadlock problem &ndash; the line highlighted in gray was found in another thread&rsquo;s call stack. This means there&rsquo;s another thread which entered <code>GetOrCreate()</code> method, took the lock on <code>cache</code> and then proceeded to invoking the <code>ModuleAdded</code> event handlers. How do we figure out why the thread is blocked here? Who else is holding the lock? Easy! Let&rsquo;s take a look at the call stack:</p><p><img src=2.png alt=image></p><p>The call stack immediately tells us that the current thread is waiting for a lock, which is already acquired by another thread &ndash; thread <code>33756</code> in this case. Since the whole application is currently stopped, we can just switch to that thread and see what is happening there:</p><p><img src=3.png alt=image></p><p>Okay, this thread is synchronously waiting for an asynchronous task. Let&rsquo;s take a look at its call stack:</p><p><img src=4.png alt=image></p><p>First thing we see here is that indeed this thread went through the <code>GetOrCreate</code> method. It took the lock on <code>cache</code> and never released it, that&rsquo;s why the main thread is stuck. Now we need to figure out why this worker thread is stuck. The call stack conveniently shows us that we&rsquo;re waiting for another <code>Task</code> to complete - task <code>12369579</code>.</p><p>Visual Studio provides an easy way to see which tasks are currently being executed and how they depend on each other &ndash; the Tasks Window. Let&rsquo;s switch there and see what it looks like for the current thread:</p><p><img src=5.png alt=image></p><p>This confirms what we saw in the call stack &ndash; current thread (which corresponds to task <code>12369578</code>) is waiting for task <code>12369579</code> to complete. The hover popup from the <code>Location</code> column gives even more information:</p><p><img src=6.png alt=image></p><p>These are all the tasks in the waiting chain: <code>12369578</code> waits for <code>12369579</code>, which waits for <code>12370519</code>, which waits for <code>12370517</code>. Let&rsquo;s switch the the last one, task <code>12370517</code>:</p><p><img src=7.png alt=image></p><p>Booyah! The task is trying to switch the main thread (i.e. to continue executing on the <strong>main</strong> thread instead of some random worker thread), which is typically done when you need to access some UI elements or, in this case, call certain Visual Studio APIs. But the main thread is blocked! Here&rsquo;s a summary in terms of call sequences:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// Main Thread</span>
</span></span><span style=display:flex><span>DebugAsyncStackFrame.GetInfo
</span></span><span style=display:flex><span><span>↪️</span> AD7FrameInfoCreator.Create
</span></span><span style=display:flex><span>  <span>↪️</span> DebugModuleCache.GetOrCreate
</span></span><span style=display:flex><span>    <span>↪️</span> <span style=color:#007020;font-weight:700>lock</span>(cache) -- waiting
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// Worker Thread</span>
</span></span><span style=display:flex><span>LldbEventManager.LldbListenerOnModulesChanged
</span></span><span style=display:flex><span><span>↪️</span> DebugModuleCache.GetOrCreate
</span></span><span style=display:flex><span>  <span>↪️</span> <span style=color:#007020;font-weight:700>lock</span>(cache) -- acquired
</span></span><span style=display:flex><span>    <span>↪️</span> ModuleAdded.Invoke
</span></span><span style=display:flex><span>      <span>↪️</span> DebugEngineHandler.SendEventAsync
</span></span><span style=display:flex><span>        <span>↪️</span> <span style=color:#007020;font-weight:700>await</span> _taskContext.Factory.SwitchToMainThreadAsync()
</span></span><span style=display:flex><span>           <span>↖️</span>
</span></span><span style=display:flex><span>            <span style=color:#60a0b0;font-style:italic>// Deadlock, main thread is waiting for lock(cache)</span>
</span></span></code></pre></div><hr><p>Fixing deadlocks can be tricky, depending on the logic of your application. Here&rsquo;s the solution I&rsquo;ve implemented for this one &ndash; <a href=https://github.com/googlestadia/vsi-lldb/commit/e66a6b5e7df879b82e535884bad3ae148b33d68c>e66a6b5e</a>. The &ldquo;obvious&rdquo; thing to do is typically move some operations outside of the critical section, but it&rsquo;s always worth looking deeper &ndash; do I even need this lock? do I have to switch to main thread to perform some operation? Taking a holistic overview often leads to better design improvements.</p><hr><p>Discuss this article on <a href=https://lobste.rs/s/qtdvpn/how_debug_deadlocks_visual_studio>lobste.rs</a></p><hr></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2017 -
2022
Andy Hippo
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a></section></footer></main><script data-goatcounter=https://werat-dev.goatcounter.com/count>(function(){"use strict";window.goatcounter&&window.goatcounter.vars?window.goatcounter=window.goatcounter.vars:window.goatcounter=window.goatcounter||{};var e,t,n,o,i,a,r,c,l,d,u,s=document.querySelector("script[data-goatcounter]");if(s&&s.dataset.goatcounterSettings){try{o=JSON.parse(s.dataset.goatcounterSettings)}catch(e){console.error("invalid JSON in data-goatcounter-settings: "+e)}for(i in o)["no_onload","no_events","allow_local","allow_frame","path","title","referrer","event"].indexOf(i)>-1&&(window.goatcounter[i]=o[i])}e=encodeURIComponent,l=function(e){var s,o,i,t={p:e.path===void 0?goatcounter.path:e.path,r:e.referrer===void 0?goatcounter.referrer:e.referrer,t:e.title===void 0?goatcounter.title:e.title,e:!!(e.event||goatcounter.event),s:[window.screen.width,window.screen.height,window.devicePixelRatio||1],b:d(),q:location.search};return typeof t.r=="function"&&(s=t.r),typeof t.t=="function"&&(i=t.t),typeof t.p=="function"&&(o=t.p),n(t.r)&&(t.r=document.referrer),n(t.t)&&(t.t=document.title),n(t.p)&&(t.p=r()),s&&(t.r=s(t.r)),i&&(t.t=i(t.t)),o&&(t.p=o(t.p)),t},n=function(e){return e==null||typeof e=="function"},d=function(){var e=window,t=document;return e.callPhantom||e._phantom||e.phantom?150:e.__nightmare?151:t.__selenium_unwrapped||t.__webdriver_evaluate||t.__driver_evaluate?152:navigator.webdriver?153:0},u=function(t){var n,s=[];for(n in t)t[n]!==""&&t[n]!==null&&t[n]!==void 0&&t[n]!==!1&&s.push(e(n)+"="+e(t[n]));return"?"+s.join("&")},t=function(e){console&&"warn"in console&&console.warn("goatcounter: "+e)},a=function(){var e=document.querySelector("script[data-goatcounter]");return e&&e.dataset.goatcounter?e.dataset.goatcounter:goatcounter.endpoint||window.counter},r=function(){var e,t=location,n=document.querySelector('link[rel="canonical"][href]');return n&&(e=document.createElement("a"),e.href=n.href,e.hostname.replace(/^www\./,"")===location.hostname.replace(/^www\./,"")&&(t=e)),t.pathname+t.search||"/"},c=function(e){document.body===null?document.addEventListener("DOMContentLoaded",function(){e()},!1):e()},goatcounter.filter=function(){return"visibilityState"in document&&document.visibilityState==="prerender"?"visibilityState":!goatcounter.allow_frame&&location!==parent.location?"frame":!goatcounter.allow_local&&location.hostname.match(/(localhost$|^127\.|^10\.|^172\.(1[6-9]|2[0-9]|3[0-1])\.|^192\.168\.|^0\.0\.0\.0$)/)?"localhost":!goatcounter.allow_local&&location.protocol==="file:"?"localfile":!!(localStorage&&localStorage.getItem("skipgc")==="t")&&"disabled with #toggle-goatcounter"},window.goatcounter.url=function(e){var s,n=l(e||{});if(n.p===null)return;return n.rnd=Math.random().toString(36).substr(2,5),s=a(),s?s+u(n):t("no endpoint found")},window.goatcounter.count=function(e){var n,s,i,o=goatcounter.filter();if(o)return t("not counting because of: "+o);if(s=goatcounter.url(e),!s)return t("not counting because path callback returned null");n=document.createElement("img"),n.src=s,n.style.position="absolute",n.style.bottom="0px",n.style.width="1px",n.style.height="1px",n.loading="eager",n.setAttribute("alt",""),n.setAttribute("aria-hidden","true"),i=function(){n&&n.parentNode&&n.parentNode.removeChild(n)},n.addEventListener("load",i,!1),document.body.appendChild(n)},window.goatcounter.get_query=function(e){for(var n=location.search.substr(1).split("&"),t=0;t<n.length;t++)if(n[t].toLowerCase().indexOf(e.toLowerCase()+"=")===0)return n[t].substr(e.length+1)},window.goatcounter.bind_events=function(){if(!document.querySelectorAll)return;var e=function(e){return function(){goatcounter.count({event:!0,path:e.dataset.goatcounterClick||e.name||e.id||"",title:e.dataset.goatcounterTitle||e.title||(e.innerHTML||"").substr(0,200)||"",referrer:e.dataset.goatcounterReferrer||e.dataset.goatcounterReferral||""})}};Array.prototype.slice.call(document.querySelectorAll("*[data-goatcounter-click]")).forEach(function(t){if(t.dataset.goatcounterBound)return;var n=e(t);t.addEventListener("click",n,!1),t.addEventListener("auxclick",n,!1),t.dataset.goatcounterBound="true"})},window.goatcounter.visit_count=function(n){c(function(){n=n||{},n.type=n.type||"html",n.append=n.append||"body",n.path=n.path||r(),n.attr=n.attr||{width:"200",height:n.no_branding?"60":"80"},n.attr.src=a()+"er/"+e(n.path)+"."+e(n.type)+"?",n.no_branding&&(n.attr.src+="&no_branding=1"),n.style&&(n.attr.src+="&style="+e(n.style)),n.start&&(n.attr.src+="&start="+e(n.start)),n.end&&(n.attr.src+="&end="+e(n.end));var s,o,c,i={png:"img",svg:"img",html:"iframe"}[n.type];if(!i)return t("visit_count: unknown type: "+n.type);n.type==="html"&&(n.attr.frameborder="0",n.attr.scrolling="no"),s=document.createElement(i);for(c in n.attr)s.setAttribute(c,n.attr[c]);if(o=document.querySelector(n.append),!o)return t("visit_count: append not found: "+n.append);o.appendChild(s)})},location.hash==="#toggle-goatcounter"&&(localStorage.getItem("skipgc")==="t"?(localStorage.removeItem("skipgc","t"),alert("GoatCounter tracking is now ENABLED in this browser.")):(localStorage.setItem("skipgc","t"),alert("GoatCounter tracking is now DISABLED in this browser until "+location+" is loaded again."))),goatcounter.no_onload||c(function(){if(!("visibilityState"in document)||document.visibilityState==="visible")goatcounter.count();else{var e=function(){if(document.visibilityState!=="visible")return;document.removeEventListener("visibilitychange",e),goatcounter.count()};document.addEventListener("visibilitychange",e)}goatcounter.no_events||goatcounter.bind_events()})})()</script></body></html>