<!doctype html><html lang=en><head><title>Running benchmarks for Pull Requests via GitHub Actions</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Andy Hippo"><meta name=description content="Benchmarks are often underestimated and don&rsquo;t get the same attention as tests. However &ldquo;performance is a feature&rdquo; and when something is not tested it might as well be just broken. If the performance is not measured/tracked regressions are inevitable.
Modern tooling makes it really easy to write benchmarks. Some languages have built-in support, for example, Rust comes with cargo bench (docs) and Go has go test -bench (docs). For C++ there is google/benchmark &ndash; not as streamlined as having it built into the language infrastructure, but still definitely worth the effort."><meta name=keywords content="blog,developer,personal,benchmark,ci,github-actions"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running benchmarks for Pull Requests via GitHub Actions"><meta name=twitter:description content="Benchmarks are often underestimated and don&rsquo;t get the same attention as tests. However &ldquo;performance is a feature&rdquo; and when something is not tested it might as well be just broken. If the performance is not measured/tracked regressions are inevitable.
Modern tooling makes it really easy to write benchmarks. Some languages have built-in support, for example, Rust comes with cargo bench (docs) and Go has go test -bench (docs). For C++ there is google/benchmark &ndash; not as streamlined as having it built into the language infrastructure, but still definitely worth the effort."><meta property="og:title" content="Running benchmarks for Pull Requests via GitHub Actions"><meta property="og:description" content="Benchmarks are often underestimated and don&rsquo;t get the same attention as tests. However &ldquo;performance is a feature&rdquo; and when something is not tested it might as well be just broken. If the performance is not measured/tracked regressions are inevitable.
Modern tooling makes it really easy to write benchmarks. Some languages have built-in support, for example, Rust comes with cargo bench (docs) and Go has go test -bench (docs). For C++ there is google/benchmark &ndash; not as streamlined as having it built into the language infrastructure, but still definitely worth the effort."><meta property="og:type" content="article"><meta property="og:url" content="https://werat.dev/blog/running-benchmarks-for-pull-requests-via-github-actions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-28T13:35:00+01:00"><meta property="article:modified_time" content="2021-06-28T13:35:00+01:00"><link rel=canonical href=https://werat.dev/blog/running-benchmarks-for-pull-requests-via-github-actions/><link rel=alternate type=application/rss+xml title=werat.dev href=https://werat.dev/index.xml><link rel=icon type=image/png href=/img/logo-avatar-32.png sizes=32x32><link rel=icon type=image/png href=/img/logo-avatar-16.png sizes=16x16><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.110.0"></head><body><header class=nav-header><nav><span class=nav-title><a href=/>werat.dev</a></span>
<a href=/posts/>Blog</a>
<a href=/talks/>Talks</a></nav></header><main><article><header><h1 class=title><a href=https://werat.dev/blog/running-benchmarks-for-pull-requests-via-github-actions/>Running benchmarks for Pull Requests via GitHub Actions</a></h1><time class=posted-on datetime=2021-06-28T13:35:00+01:00>June 28, 2021</time></header><p>Benchmarks are often underestimated and don&rsquo;t get the same attention as tests. However <a href=https://blog.codinghorror.com/performance-is-a-feature/>&ldquo;performance is a feature&rdquo;</a> and when something is not tested it might as well be just broken. If the performance is not measured/tracked regressions are inevitable.</p><p>Modern tooling makes it really easy to write benchmarks. Some languages have built-in support, for example, Rust comes with <code>cargo bench</code> (<a href=https://doc.rust-lang.org/cargo/commands/cargo-bench.html>docs</a>) and Go has <code>go test -bench</code> (<a href=https://golang.org/pkg/testing/#hdr-Benchmarks>docs</a>). For C++ there is <a href=https://github.com/google/benchmark>google/benchmark</a> &ndash; not as streamlined as having it built into the language infrastructure, but still definitely worth the effort.</p><p>Last week I was looking into setting up some automated benchmarking for my project <a href=https://github.com/google/lldb-eval>google/lldb-eval</a>. It&rsquo;s written in C++ (and already affiliated with Google ðŸ˜ƒ ), so <a href=https://github.com/google/benchmark>google/benchmark</a> feels like a natural choice. For the &ldquo;automated&rdquo; part I was thinking about a simple GitHub Action &ndash; for every pull request run the benchmark on for BASE and HEAD commits, compare the results and post them as a review comment.</p><p>The final result looks like <a href=https://github.com/google/lldb-eval/pull/131#issuecomment-846019771>this</a> and the rest of the post is about how I got there:</p><p><img src=pr-comment.png alt=image width=1082 height=357></p><hr><p>First we need to write some benchmarks. As I mentioned ealier, for that I&rsquo;m using <a href=https://github.com/google/benchmark>google/benchmark</a> &ndash; a library to benchmark code snippets, very similar to unit tests. The basic example as simple as:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#633820>#include</span> <span style=color:#633820>&lt;benchmark/benchmark.h&gt;</span><span style=color:#633820>
</span></span></span><span style=display:flex><span><span style=color:#633820></span>
</span></span><span style=display:flex><span><span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>BM_SomeFunction</span>(<span style=color:#000>benchmark</span><span style=color:#000>::</span><span style=color:#000>State</span><span style=color:#000>&amp;</span> <span style=color:#000>state</span>) {
</span></span><span style=display:flex><span>  <span style=color:#177500>// Perform setup here
</span></span></span><span style=display:flex><span><span style=color:#177500></span>  <span style=color:#a90d91>for</span> (<span style=color:#a90d91>auto</span> <span style=color:#000>_</span> : <span style=color:#000>state</span>) {
</span></span><span style=display:flex><span>    <span style=color:#177500>// This code gets timed
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>SomeFunction</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// Register the function as a benchmark
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>BENCHMARK</span>(<span style=color:#000>BM_SomeFunction</span>);
</span></span></code></pre></div><p>Real-life examples might require one-time setup and teardown logic (e.g. launch a process, attach the debugger, shutdown everything at the end), which can be implemented via <a href=https://github.com/google/benchmark/#fixtures>Fixtures</a>. There are more advanced features, but I&rsquo;m not using them at the moment. The current set of benchmarks for <code>lldb-eval</code> can be found in <a href=https://github.com/google/lldb-eval/blob/4317381e1fa6b97aa661d8f274121ca4fd5fe889/lldb-eval/eval_benchmark.cc>lldb-eval/eval-benchmarks.cc</a>.</p><p>Using <a href=https://github.com/google/benchmark>google/benchmark</a> with Bazel is pretty straightforward. The library already has support for building with Bazel (<a href=https://github.com/google/benchmark/blob/master/BUILD.bazel>BUILD.bazel</a>), so you just need to declare the dependency in your <code>WORKSPACE</code> file and then you can use it as any other third-party library.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#633820># WORKSPACE
</span></span></span><span style=display:flex><span><span style=color:#633820></span><span style=color:#000>http_archive</span>(
</span></span><span style=display:flex><span>    <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;com_google_benchmark&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>sha256</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;bdefa4b03c32d1a27bd50e37ca466d8127c1688d834800c38f3c587a396188ee&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>strip_prefix</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;benchmark-1.5.3&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>urls</span> <span style=color:#000>=</span> [<span style=color:#c41a16>&#34;https://github.com/google/benchmark/archive/v1.5.3.zip&#34;</span>],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#633820># BUILD
</span></span></span><span style=display:flex><span><span style=color:#633820></span><span style=color:#000>cc_binary</span>(
</span></span><span style=display:flex><span>    <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;benchmark&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>srcs</span> <span style=color:#000>=</span> [<span style=color:#c41a16>&#34;benchmark.cc&#34;</span>],
</span></span><span style=display:flex><span>    <span style=color:#000>deps</span> <span style=color:#000>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;:your_library&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;@com_google_benchmark//:benchmark_main&#34;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>The <code>benchmark</code> target here is a regular <code>cc_binary</code>, so you can run it with <code>bazel run</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; bazel run -c opt :benchmark
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>----------------------------------------------------------
</span></span><span style=display:flex><span>Benchmark                Time             CPU   Iterations
</span></span><span style=display:flex><span>----------------------------------------------------------
</span></span><span style=display:flex><span>BM_SomeFunction      <span style=color:#1c01ce>23141</span> ns        <span style=color:#1c01ce>23077</span> ns        <span style=color:#1c01ce>30307</span>
</span></span></code></pre></div><hr><p>Now we need to figure out how to make this into some automated process. Searching the GitHub Marketplace yielded a <code>GitHub Action for Continuous Benchmarking</code> (<a href=https://github.com/rhysd/github-action-benchmark>rhysd/github-action-benchmark</a>). It seems to support a number of languages and frameworks (Rust, Go, C++, JS, Python) as well as polyglot projects (i.e. multiple languages in the same repository) and has a handful of features &ndash; e.g. it can record all your measurements and display nice charts showing the performance over time &ndash; <a href=https://rhysd.github.io/github-action-benchmark/dev/bench>https://rhysd.github.io/github-action-benchmark/dev/bench</a>.</p><p>However it doesn&rsquo;t seem to support the simplest workflow I wanted &ndash; just run the benchmark for incoming changes and show if there are performance regressions or improvements. Moreover the documentation explicitly doesn&rsquo;t recommend to run the action on pull requests:</p><blockquote><p>Please ensure that your benchmark workflow runs only on your branches. Please avoid running it on pull requests. If a branch were pushed to GitHub pages branch on a pull request, anyone who creates a pull request on your repository could modify your GitHub pages branch.</p></blockquote><p>I guess it&rsquo;s time to write some YAML :)</p><p><strong>TL;DR</strong> the final workflow is here &ndash; <a href=https://github.com/google/lldb-eval/blob/4317381e1fa6b97aa661d8f274121ca4fd5fe889/.github/workflows/benchmarks.yml>lldb-eval/.github/workflows/benchmarks.yml</a>. Below I will cover the most interesting parts.</p><p>The basic setup is trivial: trigger on pull requests, run on Ubuntu, checkout the repo, create some temporary files for intermediate results, etc. The interesting part starts with running the benchmarks. We need to run the benchmarks twice: for the BASE (i.e. parent) and for the HEAD ref (i.e. pull request). In <code>git</code> it&rsquo;s easy to switch between commits &ndash; sounds like a job for the <code>git checkout</code> command:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#177500># Run for BASE</span>
</span></span><span style=display:flex><span>git checkout <span style=color:#c41a16>${</span>{ github.event.pull_request.base.sha <span style=color:#c41a16>}</span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>bazel run lldb-eval:eval_benchmark &gt; base.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Run for HEAD</span>
</span></span><span style=display:flex><span>git checkout <span style=color:#c41a16>${</span>{ github.event.pull_request.head.sha <span style=color:#c41a16>}</span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>bazel run lldb-eval:eval_benchmark &gt; head.json
</span></span></code></pre></div><blockquote><p>Some parameters are omitted for simplicity, see full script in <a href=https://github.com/google/lldb-eval/blob/4317381e1fa6b97aa661d8f274121ca4fd5fe889/.github/workflows/benchmarks.yml>benchmarks.yml</a></p></blockquote><p>For comparing two benchmark runs <a href=https://github.com/google/benchmark>google/benchmark</a> provides a script <a href=https://github.com/google/benchmark/blob/db2de74cc8c34131a6f673e35751935cc1897a0d/tools/compare.py>tools/compare.py</a>. Sounds like exactly what we need! When using it with GitHub Actions I&rsquo;ve encountered a small hiccup, however. Just calling <code>bazel run //tools:compare</code> fails with a quite cryptic error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bazel run //tools:compare -- --no-color benchmarks base.json head.json
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>Traceback</span> (<span style=color:#000>most</span> <span style=color:#000>recent</span> <span style=color:#000>call</span> <span style=color:#000>last</span>):
</span></span><span style=display:flex><span>  <span style=color:#000>File</span> <span style=color:#c41a16>&#34;/home/runner/.cache/bazel/_bazel_runner/77c7513313c82b78a5db5d85413329b8/execroot/com_github_google_benchmark/bazel-out/k8-py2-fastbuild/bin/tools/compare.runfiles/com_github_google_benchmark/tools/compare.py&#34;</span>, <span style=color:#000>line</span> <span style=color:#1c01ce>13</span>, <span style=color:#000>in</span> <span style=color:#000>&lt;</span><span style=color:#000>module</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>from</span> <span style=color:#000>gbench</span> <span style=color:#a90d91>import</span> <span style=color:#000>util</span>, <span style=color:#000>report</span>
</span></span><span style=display:flex><span>  <span style=color:#000>File</span> <span style=color:#c41a16>&#34;/home/runner/work/lldb-eval/lldb-eval/google_benchmark/tools/gbench/report.py&#34;</span>, <span style=color:#000>line</span> <span style=color:#1c01ce>8</span>, <span style=color:#000>in</span> <span style=color:#000>&lt;</span><span style=color:#000>module</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>from</span> <span style=color:#000>scipy.stats</span> <span style=color:#a90d91>import</span> <span style=color:#000>mannwhitneyu</span>
</span></span><span style=display:flex><span>  <span style=color:#000>File</span> <span style=color:#c41a16>&#34;/home/runner/.cache/bazel/_bazel_runner/77c7513313c82b78a5db5d85413329b8/execroot/com_github_google_benchmark/bazel-out/k8-py2-fastbuild/bin/tools/compare.runfiles/py_deps/pypi__scipy/scipy/__init__.py&#34;</span>, <span style=color:#000>line</span> <span style=color:#1c01ce>61</span>, <span style=color:#000>in</span> <span style=color:#000>&lt;</span><span style=color:#000>module</span><span style=color:#000>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>from</span> <span style=color:#000>numpy</span> <span style=color:#a90d91>import</span> <span style=color:#000>show_config</span> <span style=color:#a90d91>as</span> <span style=color:#000>show_numpy_config</span>
</span></span><span style=display:flex><span>  <span style=color:#000>File</span> <span style=color:#c41a16>&#34;/home/runner/.cache/bazel/_bazel_runner/77c7513313c82b78a5db5d85413329b8/execroot/com_github_google_benchmark/bazel-out/k8-py2-fastbuild/bin/tools/compare.runfiles/py_deps/pypi__numpy/numpy/__init__.py&#34;</span>, <span style=color:#000>line</span> <span style=color:#1c01ce>292</span>
</span></span><span style=display:flex><span><span style=color:#000>SyntaxError</span>: <span style=color:#000>Non</span><span style=color:#000>-</span><span style=color:#000>ASCII</span> <span style=color:#000>character</span> <span style=color:#c41a16>&#39;</span><span style=color:#c41a16>\xef</span><span style=color:#c41a16>&#39;</span> <span style=color:#000>in</span> <span style=color:#000>file</span> <span style=color:#000>/</span><span style=color:#000>home</span><span style=color:#000>/</span><span style=color:#000>runner</span><span style=color:#000>/.</span><span style=color:#000>cache</span><span style=color:#000>/</span><span style=color:#000>bazel</span><span style=color:#000>/</span><span style=color:#000>_bazel_runner</span><span style=color:#000>/</span><span style=color:#1c01ce>77</span><span style=color:#000>c7513313c82b78a5db5d85413329b8</span><span style=color:#000>/</span><span style=color:#000>execroot</span><span style=color:#000>/</span><span style=color:#000>com_github_google_benchmark</span><span style=color:#000>/</span><span style=color:#000>bazel</span><span style=color:#000>-</span><span style=color:#000>out</span><span style=color:#000>/</span><span style=color:#000>k8</span><span style=color:#000>-</span><span style=color:#000>py2</span><span style=color:#000>-</span><span style=color:#000>fastbuild</span><span style=color:#000>/</span><span style=color:#a90d91>bin</span><span style=color:#000>/</span><span style=color:#000>tools</span><span style=color:#000>/</span><span style=color:#000>compare</span><span style=color:#000>.</span><span style=color:#000>runfiles</span><span style=color:#000>/</span><span style=color:#000>py_deps</span><span style=color:#000>/</span><span style=color:#000>pypi__numpy</span><span style=color:#000>/</span><span style=color:#000>numpy</span><span style=color:#000>/</span><span style=color:#000>__init__</span><span style=color:#000>.</span><span style=color:#000>p</span> <span style=color:#000>on</span> <span style=color:#000>line</span> <span style=color:#1c01ce>293</span>, <span style=color:#000>but</span> <span style=color:#000>no</span> <span style=color:#000>encoding</span> <span style=color:#000>declared</span>; <span style=color:#000>see</span> <span style=color:#000>http</span>:<span style=color:#000>//</span><span style=color:#000>python</span><span style=color:#000>.</span><span style=color:#000>org</span><span style=color:#000>/</span><span style=color:#000>dev</span><span style=color:#000>/</span><span style=color:#000>peps</span><span style=color:#000>/</span><span style=color:#000>pep</span><span style=color:#000>-</span><span style=color:#1c01ce>0263</span><span style=color:#000>/</span> <span style=color:#a90d91>for</span> <span style=color:#000>details</span>
</span></span></code></pre></div><p>Hmmm, what is this character <code>'\xef'</code>?? I don&rsquo;t see anything suspicious (<a href=https://github.com/numpy/numpy/blob/6d7b8aaed5ae9f0435764675ebac8c9ada06738f/numpy/__init__.py#L292>link</a>):</p><p><img src=numpy-mac.png alt=image width=623 height=302></p><p>Let&rsquo;s try downloading this file and look what&rsquo;s actually there:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>In</span> [<span style=color:#1c01ce>1</span>]: <span style=color:#000>r</span> <span style=color:#000>=</span> <span style=color:#000>requests</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#c41a16>&#39;https://raw.githubusercontent.com/numpy/numpy/6d7b8aaed5ae9f0435764675ebac8c9ada06738f/numpy/__init__.py&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>In</span> [<span style=color:#1c01ce>2</span>]: <span style=color:#000>lines</span> <span style=color:#000>=</span> <span style=color:#000>r</span><span style=color:#000>.</span><span style=color:#000>content</span><span style=color:#000>.</span><span style=color:#000>split</span>(<span style=color:#c41a16>b</span><span style=color:#c41a16>&#39;</span><span style=color:#c41a16>\n</span><span style=color:#c41a16>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>In</span> [<span style=color:#1c01ce>3</span>]: <span style=color:#000>lines</span>[<span style=color:#1c01ce>290</span>]
</span></span><span style=display:flex><span><span style=color:#000>Out</span>[<span style=color:#1c01ce>3</span>]: <span style=color:#c41a16>b</span><span style=color:#c41a16>&#39;        Quick Sanity check for Windows OS: look for fmod bug issue 16744.</span><span style=color:#c41a16>\n</span><span style=color:#c41a16>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>In</span> [<span style=color:#1c01ce>4</span>]: <span style=color:#000>lines</span>[<span style=color:#1c01ce>291</span>]
</span></span><span style=display:flex><span><span style=color:#000>Out</span>[<span style=color:#1c01ce>4</span>]: <span style=color:#c41a16>b</span><span style=color:#c41a16>&#39;</span><span style=color:#c41a16>\xef\xbf\xbc</span><span style=color:#c41a16>       &#34;&#34;&#34;</span><span style=color:#c41a16>\n</span><span style=color:#c41a16>&#39;</span>
</span></span></code></pre></div><p>&mldr; What the heck? At least this matches the error message <code>Non-ASCII character '\xef' ...</code>. <code>\xef\xbf\xbc</code> is <code>\uFFFC</code> in Unicode and means <a href="https://codepoints.net/U+FFFC?lang=en">OBJECT REPLACEMENT CHARACTER</a>. In this particular case it looks like just a mistake. In Python 3 the source files are implicitly treated as UTF8 and this symbol is ignored. In Python 2 the default encoding is ASCII, hence the error.</p><p>The Bazel rule builds and runs the script with <code>python_version = "PY2"</code> (<a href=https://github.com/google/benchmark/blob/db2de74cc8c34131a6f673e35751935cc1897a0d/tools/BUILD.bazel#L15>src</a>), but the versions of <code>numpy</code> and <code>scipy</code> defined in the requirements have already dropped support for Python 2. Luckily <code>compare.py</code> is Python 3 compatible, so there we can just replace <code>PY2->PY3</code> with a sed-spell:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -i <span style=color:#c41a16>&#39;s/PY2/PY3/g&#39;</span> tools/BUILD.bazel
</span></span></code></pre></div><p>The comparison step in the GitHub Action now looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sed -i <span style=color:#c41a16>&#39;s/PY2/PY3/g&#39;</span> tools/BUILD.bazel
</span></span><span style=display:flex><span>bazel run //tools:compare -- --no-color benchmarks base.json head.json &gt; cmp_results
</span></span></code></pre></div><p>Now that we&rsquo;ve managed to run the benchmarks and get the comparison results the only thing left is to post the results somewhere. I&rsquo;ve decided to submit the results as a comment to the pull request being tested. GitHub supports Markdown in comments, so we can render a nice table with some links:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#177500># Sometime earlier...</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;BASE_SHA=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>${</span>{ github.event.pull_request.base.sha <span style=color:#c41a16>}</span><span style=color:#000>}</span> | cut -c1-8<span style=color:#a90d91>)</span><span style=color:#c41a16>&#34;</span> &gt;&gt; <span style=color:#000>$GITHUB_ENV</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;HEAD_SHA=</span><span style=color:#a90d91>$(</span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>${</span>{ github.event.pull_request.head.sha <span style=color:#c41a16>}</span><span style=color:#000>}</span> | cut -c1-8<span style=color:#a90d91>)</span><span style=color:#c41a16>&#34;</span> &gt;&gt; <span style=color:#000>$GITHUB_ENV</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;PR_COMMENT=</span><span style=color:#a90d91>$(</span>mktemp<span style=color:#a90d91>)</span><span style=color:#c41a16>&#34;</span> &gt;&gt; <span style=color:#000>$GITHUB_ENV</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Format the comment.</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;Benchmark comparison for [`${{ env.BASE_SHA }}`](${{ github.event.repository.html_url }}/commit/${{ github.event.pull_request.base.sha }}) (base) vs [`${{ env.HEAD_SHA }}`](${{ github.event.repository.html_url }}/commit/${{ github.event.pull_request.head.sha }}) (PR)&#39;</span> &gt;&gt; pr_comment
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;```&#39;</span> &gt;&gt; pr_comment
</span></span><span style=display:flex><span>tail -n +2 cmp_results &gt;&gt; pr_comment  <span style=color:#177500># Skip the first line saying &#34;Comparing XX to YY&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#39;```&#39;</span> &gt;&gt; pr_comment
</span></span><span style=display:flex><span>cat pr_comment &gt; <span style=color:#c41a16>${</span>{ env.PR_COMMENT <span style=color:#c41a16>}</span><span style=color:#000>}</span>
</span></span></code></pre></div><p>For actually posting the comment we can use <a href=https://github.com/actions/github-script>actions/github-script</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>name</span>: <span style=color:#c41a16>&#39;Comment PR&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>uses</span>: <span style=color:#1c01ce>actions/github-script@v4.0.2</span>
</span></span><span style=display:flex><span>  <span style=color:#000>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>github-token</span>: <span style=color:#1c01ce>${{ secrets.GITHUB_TOKEN }}</span>
</span></span><span style=display:flex><span>    <span style=color:#000>script</span>: |<span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      github.issues.createComment({
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        issue_number: context.issue.number,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        owner: context.repo.owner,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        repo: context.repo.repo,
</span></span></span><span style=display:flex><span><span style=color:#c41a16>        body: require(&#39;fs&#39;).readFileSync(&#39;${{ env.PR_COMMENT }}&#39;).toString()
</span></span></span><span style=display:flex><span><span style=color:#c41a16>      });</span>      
</span></span></code></pre></div><p>Again, the final workflow is available here &ndash; <a href=https://github.com/google/lldb-eval/blob/4317381e1fa6b97aa661d8f274121ca4fd5fe889/.github/workflows/benchmarks.yml>lldb-eval/.github/workflows/benchmarks.yml</a>.</p><hr><p>Happy benchmarking!</p></article></main><footer>Â© 2017 - 2023 Andy Hippo
Â· Licensed under <a href=https://github.com/werat/werat.github.io/blob/main/LICENSE>MIT</a></footer><script data-goatcounter=https://werat-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>