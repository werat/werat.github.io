<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=color-scheme content="light dark"><meta name=author content="Andy Hippo"><meta name=description content="Sometimes you want to (or need to) debug a program that you didn&rsquo;t build yourself and you don&rsquo;t even know how exactly it was built. Depending on the specifics of your setup that could mean many different things:
Built on a build farm, running on a production server/container Installed via apt or similar, running locally &mldr; This post is inspired by my experience of debugging LLDB. Debugging the debugger is always interesting and tricky, even without the additional difficulties like trying to get the source stepping to work :)"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debugging LLDB with source stepping"><meta name=twitter:description content="Sometimes you want to (or need to) debug a program that you didn&rsquo;t build yourself and you don&rsquo;t even know how exactly it was built. Depending on the specifics of your setup that could mean many different things:
Built on a build farm, running on a production server/container Installed via apt or similar, running locally &mldr; This post is inspired by my experience of debugging LLDB. Debugging the debugger is always interesting and tricky, even without the additional difficulties like trying to get the source stepping to work :)"><meta property="og:title" content="Debugging LLDB with source stepping"><meta property="og:description" content="Sometimes you want to (or need to) debug a program that you didn&rsquo;t build yourself and you don&rsquo;t even know how exactly it was built. Depending on the specifics of your setup that could mean many different things:
Built on a build farm, running on a production server/container Installed via apt or similar, running locally &mldr; This post is inspired by my experience of debugging LLDB. Debugging the debugger is always interesting and tricky, even without the additional difficulties like trying to get the source stepping to work :)"><meta property="og:type" content="article"><meta property="og:url" content="https://werat.dev/blog/debugging-lldb-with-source-stepping/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-10-11T18:35:00+01:00"><meta property="article:modified_time" content="2020-10-11T18:35:00+01:00"><title>Debugging LLDB with source stepping · Reboot and Shine</title><link rel=canonical href=https://werat.dev/blog/debugging-lldb-with-source-stepping/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.34dfa7b2f5cdeb0f5302b2628f4a7a4bfe88a2431e1397ee4ec605c56ab69701.css integrity="sha256-NN+nsvXN6w9TArJij0p6S/6IokMeE5fuTsYFxWq2lwE=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/custom.css><link rel=icon type=image/png href=/img/logo-avatar-32.png sizes=32x32><link rel=icon type=image/png href=/img/logo-avatar-16.png sizes=16x16><link rel=apple-touch-icon href=/img/logo-avatar.jpg><link rel=apple-touch-icon sizes=180x180 href=/img/logo-avatar.jpg><meta name=generator content="Hugo 0.100.2"></head><body class="preload-transitions colorscheme-light"><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Reboot and Shine</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/talks/>Talks</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://werat.dev/blog/debugging-lldb-with-source-stepping/>Debugging LLDB with source stepping</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2020-10-11T18:35:00+01:00>October 11, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/lldb/>lldb</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/debugging/>debugging</a></span></div></div></header><div><p>Sometimes you want to (or <em>need</em> to) debug a program that you didn&rsquo;t build yourself and you don&rsquo;t even know <em>how exactly</em> it was built. Depending on the specifics of your setup that could mean many different things:</p><ul><li>Built on a build farm, running on a production server/container</li><li>Installed via <code>apt</code> or similar, running locally</li><li>&mldr;</li></ul><p>This post is inspired by my experience of debugging <a href=https://lldb.llvm.org/>LLDB</a>. Debugging the debugger is always interesting and tricky, even without the additional difficulties like trying to get the source stepping to work :)</p><p>The LLDB I was debugging was installed via <code>apt</code> on Ubuntu (namely <code>lldb-10</code>). Unfortunately, the binary I built from source myself didn&rsquo;t reproduce the issue, so I was stuck with debugging the prebuilt one. At least the debug symbols are available, you just need to install them separately (you&rsquo;re quite lucky if the already has them!). In my case that means <code>liblldb-10-dbgsym</code>.</p><p>Now if you try debugging you&rsquo;ll see that the debugger shows you an assembly rather than the source code, even though the debug info has the information about the context (source files, line numbers, etc):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666>(</span>lldb<span style=color:#666>)</span> <span style=color:#007020;font-weight:700>continue</span>
</span></span><span style=display:flex><span>Process <span style=color:#40a070>3096063</span> resuming
</span></span><span style=display:flex><span>Process <span style=color:#40a070>3096063</span> stopped
</span></span><span style=display:flex><span>* thread <span style=color:#60a0b0;font-style:italic>#1, name = &#39;exec&#39;, stop reason = breakpoint 2.2</span>
</span></span><span style=display:flex><span>    frame <span style=color:#60a0b0;font-style:italic>#0: 0x00007fffefdcb750 liblldb-10.so.1`lldb::SBTarget::CreateValueFromData(char const*, lldb::SBData, lldb::SBType)</span>
</span></span><span style=display:flex><span>liblldb-10.so.1<span style=color:#4070a0>`</span>lldb::SBTarget::CreateValueFromData:
</span></span><span style=display:flex><span>-&gt;  0x7fffefdcb750 &lt;+0&gt;: pushq  %rbp
</span></span><span style=display:flex><span>    0x7fffefdcb751 &lt;+1&gt;: pushq  %r15
</span></span><span style=display:flex><span>    0x7fffefdcb753 &lt;+3&gt;: pushq  %r14
</span></span><span style=display:flex><span>    0x7fffefdcb755 &lt;+5&gt;: pushq  %r13
</span></span></code></pre></div><p>This is because the debugger doesn&rsquo;t have the source code! When you&rsquo;re debugging the binary you&rsquo;ve just built yourself this is not an issue, because the debug info references your local source code. But since the binary was built somewhere else, the original source code is not available anymore.</p><p>Luckily, all modern debuggers can do &ldquo;source mapping&rdquo; &ndash; you can tell where the source code is and the debugger will use it for all matched references. In LLDB one can use <code>target.source-map</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666>(</span>lldb<span style=color:#666>)</span> settings <span style=color:#007020>set</span> target.source-map /buildbot/path /my/path
</span></span></code></pre></div><p>First we need to figure out the <em>original</em> source path, i.e. the one used for building the target binary (<code>/buildbot/path</code> in the example above). Since we didn&rsquo;t build the binary, we don&rsquo;t know the path. But that&rsquo;s not a problem, because it&rsquo;s saved somewhere in the debug info (otherwise the debuggers wouldn&rsquo;t be able the source stepping at all).</p><p>The easiest way to extract it is to use <code>image lookup</code> while debugging:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#666>(</span>lldb<span style=color:#666>)</span> image lookup -vn CreateValueFromData
</span></span><span style=display:flex><span><span style=color:#40a070>2</span> matches found in /usr/lib/x86_64-linux-gnu/liblldb-10.so.1:
</span></span><span style=display:flex><span>        Address: liblldb-10.so.1<span style=color:#666>[</span>0x0000000000342750<span style=color:#666>]</span> <span style=color:#666>(</span>liblldb-10.so.1.PT_LOAD<span style=color:#666>[</span>0<span style=color:#666>]</span>..text + 1445344<span style=color:#666>)</span>
</span></span><span style=display:flex><span>        Summary: liblldb-10.so.1<span style=color:#4070a0>`</span>::CreateValueFromData<span style=color:#666>()</span> at SBTarget.cpp:1488
</span></span><span style=display:flex><span>         Module: <span style=color:#bb60d5>file</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;/usr/lib/x86_64-linux-gnu/liblldb-10.so.1&#34;</span>, <span style=color:#bb60d5>arch</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;x86_64&#34;</span>
</span></span><span style=display:flex><span>    CompileUnit: <span style=color:#bb60d5>id</span> <span style=color:#666>=</span> <span style=color:#666>{</span>0x00000031<span style=color:#666>}</span>, <span style=color:#bb60d5>file</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;/build/llvm-toolchain-10-GjIltB/llvm-toolchain-10-10.0.0/lldb/source/API/SBTarget.cpp&#34;</span>, <span style=color:#bb60d5>language</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;c++14&#34;</span>
</span></span><span style=display:flex><span>       Function: <span style=color:#bb60d5>id</span> <span style=color:#666>=</span> <span style=color:#666>{</span>0x7fffffff002e1822<span style=color:#666>}</span>, <span style=color:#bb60d5>name</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;::CreateValueFromData()&#34;</span>, <span style=color:#bb60d5>range</span> <span style=color:#666>=</span> <span style=color:#666>[</span>0x00007ffff712d750-0x00007ffff712db76<span style=color:#666>)</span>
</span></span><span style=display:flex><span>       FuncType: <span style=color:#bb60d5>id</span> <span style=color:#666>=</span> <span style=color:#666>{</span>0x7fffffff002e1822<span style=color:#666>}</span>, byte-size <span style=color:#666>=</span> 0, <span style=color:#bb60d5>compiler_type</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#34;void (void)&#34;</span>
</span></span><span style=display:flex><span>         Blocks: <span style=color:#bb60d5>id</span> <span style=color:#666>=</span> <span style=color:#666>{</span>0x7fffffff002e1822<span style=color:#666>}</span>, <span style=color:#bb60d5>range</span> <span style=color:#666>=</span> <span style=color:#666>[</span>0x7ffff712d750-0x7ffff712db76<span style=color:#666>)</span>
</span></span><span style=display:flex><span>      LineEntry: <span style=color:#666>[</span>0x00007ffff712d750-0x00007ffff712d77c<span style=color:#666>)</span>: /build/llvm-toolchain-10-GjIltB/llvm-toolchain-10-10.0.0/lldb/source/API/SBTarget.cpp:1488
</span></span><span style=display:flex><span>         Symbol: <span style=color:#bb60d5>id</span> <span style=color:#666>=</span> <span style=color:#666>{</span>0x0000b0fc<span style=color:#666>}</span>, <span style=color:#bb60d5>range</span> <span style=color:#666>=</span> <span style=color:#666>[</span>0x00007ffff712d750-0x00007ffff712db76<span style=color:#666>)</span>, <span style=color:#bb60d5>name</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;lldb::SBTarget::CreateValueFromData(char const*, lldb::SBData, lldb::SBType)&#34;</span>, <span style=color:#bb60d5>mangled</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;_ZN4lldb8SBTarget19CreateValueFromDataEPKcNS_6SBDataENS_6SBTypeE&#34;</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>(<code>CreateValueFromData</code> is some random function from the binary we&rsquo;re inspecting)</p><p>Bingo! The source path prefix we&rsquo;re looking for is <code>/build/llvm-toolchain-10-GjIltB/llvm-toolchain-10-10.0.0</code>.</p><hr><p>Another way is to inspect the debug info directly.</p><p>Lookup the location of the debug info:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; readelf --debug-dump /usr/lib/llvm-10/lib/liblldb.so
</span></span><span style=display:flex><span>Contents of the .gnu_debuglink section:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Separate debug info file: 617fb09b6875c831220b21d028cc7443dda882.debug
</span></span><span style=display:flex><span>  CRC value: 0x3e9d3f54
</span></span></code></pre></div><p>Peek into the actual DWARF:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; readelf --debug-dump<span style=color:#666>=</span>info /usr/lib/debug/.build-id/4b/617fb09b6875c831220b21d028cc7443dda882.debug
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Contents of the .debug_info section:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Compilation Unit @ offset 0x0:
</span></span><span style=display:flex><span>   Length:        0xdd39 <span style=color:#666>(</span>32-bit<span style=color:#666>)</span>
</span></span><span style=display:flex><span>   Version:       <span style=color:#40a070>4</span>
</span></span><span style=display:flex><span>   Abbrev Offset: 0x0
</span></span><span style=display:flex><span>   Pointer Size:  <span style=color:#40a070>8</span>
</span></span><span style=display:flex><span> &lt;0&gt;&lt;b&gt;: Abbrev Number: <span style=color:#40a070>1</span> <span style=color:#666>(</span>DW_TAG_compile_unit<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    &lt;c&gt;   DW_AT_producer    : <span style=color:#666>(</span>indirect string, offset: 0x3bded7<span style=color:#666>)</span>: Debian clang version 10.0.0-4
</span></span><span style=display:flex><span>    &lt;10&gt;   DW_AT_language    : <span style=color:#40a070>33</span>       <span style=color:#666>(</span>C++14<span style=color:#666>)</span>
</span></span><span style=display:flex><span>    &lt;12&gt;   DW_AT_name        : <span style=color:#666>(</span>indirect string, offset: 0x1de52<span style=color:#666>)</span>: /build/llvm-toolchain-10-GjIltB/llvm-toolchain-10-10.0.0/lldb/source/API/SBAddress.cpp
</span></span><span style=display:flex><span>    &lt;16&gt;   DW_AT_stmt_list   : 0x0
</span></span><span style=display:flex><span>    &lt;1a&gt;   DW_AT_comp_dir    : <span style=color:#666>(</span>indirect string, offset: 0x4d5f6<span style=color:#666>)</span>: /build/llvm-toolchain-10-GjIltB/llvm-toolchain-10-10.0.0/build-llvm/tools/clang/stage2-bins/
</span></span><span style=display:flex><span>tools/lldb/source/API
</span></span><span style=display:flex><span>    &lt;1e&gt;   DW_AT_low_pc      : 0x0
</span></span><span style=display:flex><span>    &lt;26&gt;   DW_AT_ranges      : 0x3290
</span></span></code></pre></div><p>The path is in the <code>DW_AT_name</code> attribute.</p><hr><p>Now that we have a prefix we can remap the sources in the debugger via <code>target.source-map</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>settings <span style=color:#007020>set</span> target.source-map /build/llvm-toolchain-10-GjIltB/llvm-toolchain-10-10.0.0/ /home/werat/src/llvm-project/
</span></span></code></pre></div><p>&mldr; and starting debugging!</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Process <span style=color:#40a070>1967456</span> stopped
</span></span><span style=display:flex><span>* thread <span style=color:#60a0b0;font-style:italic>#1, name = &#39;main&#39;, stop reason = step over</span>
</span></span><span style=display:flex><span>    frame <span style=color:#60a0b0;font-style:italic>#0: 0x00007ffff7039cec liblldb-10.so.1`::Initialize() at SBDebugger.cpp:152:3</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>149</span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>150</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>151</span>  void SBDebugger::Initialize<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>-&gt; <span style=color:#40a070>152</span>    LLDB_RECORD_STATIC_METHOD_NO_ARGS<span style=color:#666>(</span>void, SBDebugger, Initialize<span style=color:#666>)</span>;
</span></span><span style=display:flex><span>   <span style=color:#40a070>153</span>    SBError <span style=color:#bb60d5>ignored</span> <span style=color:#666>=</span> SBDebugger::InitializeWithErrorHandling<span style=color:#666>()</span>;
</span></span><span style=display:flex><span>   <span style=color:#40a070>154</span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>155</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>lldb<span style=color:#666>)</span> n
</span></span><span style=display:flex><span>Process <span style=color:#40a070>1967456</span> stopped
</span></span><span style=display:flex><span>* thread <span style=color:#60a0b0;font-style:italic>#1, name = &#39;main&#39;, stop reason = step over</span>
</span></span><span style=display:flex><span>    frame <span style=color:#60a0b0;font-style:italic>#0: 0x00007ffff7039d55 liblldb-10.so.1`::Initialize() at SBDebugger.cpp:153:21</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>150</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>151</span>  void SBDebugger::Initialize<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>152</span>    LLDB_RECORD_STATIC_METHOD_NO_ARGS<span style=color:#666>(</span>void, SBDebugger, Initialize<span style=color:#666>)</span>;
</span></span><span style=display:flex><span>-&gt; <span style=color:#40a070>153</span>    SBError <span style=color:#bb60d5>ignored</span> <span style=color:#666>=</span> SBDebugger::InitializeWithErrorHandling<span style=color:#666>()</span>;
</span></span><span style=display:flex><span>   <span style=color:#40a070>154</span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>155</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>156</span>  lldb::SBError SBDebugger::InitializeWithErrorHandling<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span><span style=color:#666>(</span>lldb<span style=color:#666>)</span> s
</span></span><span style=display:flex><span>Process <span style=color:#40a070>1967456</span> stopped
</span></span><span style=display:flex><span>* thread <span style=color:#60a0b0;font-style:italic>#1, name = &#39;main&#39;, stop reason = step in</span>
</span></span><span style=display:flex><span>    frame <span style=color:#60a0b0;font-style:italic>#0: 0x00007ffff7039e1f liblldb-10.so.1`::InitializeWithErrorHandling() at SBDebugger.cpp:157</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>154</span>  <span style=color:#666>}</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>155</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>156</span>  lldb::SBError SBDebugger::InitializeWithErrorHandling<span style=color:#666>()</span> <span style=color:#666>{</span>
</span></span><span style=display:flex><span>-&gt; <span style=color:#40a070>157</span>    LLDB_RECORD_STATIC_METHOD_NO_ARGS<span style=color:#666>(</span>lldb::SBError, SBDebugger,
</span></span><span style=display:flex><span>   <span style=color:#40a070>158</span>                                      InitializeWithErrorHandling<span style=color:#666>)</span>;
</span></span><span style=display:flex><span>   <span style=color:#40a070>159</span>
</span></span><span style=display:flex><span>   <span style=color:#40a070>160</span>    SBError error;
</span></span></code></pre></div><p>The steps above are quite typical when debugging non-locally-built binaries (e.g. debugging your payment service in production, fun 🤠 ). Depending on what kind of debug info is actually available you might not be able to do all the the usual debug operations you&rsquo;re used to &ndash; for example, inspect local variables via <code>frame variable foo</code>.</p><p>But hey, that&rsquo;s still better than decoding the assembly yourself, right?</p></div><footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var t=document,e=t.createElement('script');e.async=!0,e.src='//werat-github-io.disqus.com/embed.js',e.setAttribute('data-timestamp',+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></section></div><footer class=footer><section class=container>©
2017 -
2022
Andy Hippo
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.1e7ed4c0db4e8708b345265f5fcd5fbbd6753672f2f79f33c5dacbd22f524208.js integrity="sha256-Hn7UwNtOhwizRSZfX81fu9Z1NnLy958zxdrL0i9SQgg="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-91441325-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-91441325-1')</script></body></html>