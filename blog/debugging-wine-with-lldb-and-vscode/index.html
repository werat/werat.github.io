<!doctype html><html lang=en><head><title>Debugging Wine with LLDB and VSCode | Andy Hippo</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Andy Hippo"><meta name=description content="


In my previous post about Wine I mentioned working on a debugger that is capable of debugging both the Wine layer and the Windows application running with it. Time to share some details!"><meta name=keywords content="blog,developer,personal,debugging,gaming,linux,lldb,vscode,windows,wine"><link rel=me href=https://mastodon.social/@werat><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://werat.dev/blog/debugging-wine-with-lldb-and-vscode/debugging-doggo.png"><meta name=twitter:title content="Debugging Wine with LLDB and VSCode"><meta name=twitter:description content="In my previous post about Wine I mentioned working on a debugger that is capable of debugging both the Wine layer and the Windows application running with it. Time to share some details!"><meta property="og:url" content="https://werat.dev/blog/debugging-wine-with-lldb-and-vscode/"><meta property="og:site_name" content="werat.dev"><meta property="og:title" content="Debugging Wine with LLDB and VSCode"><meta property="og:description" content="In my previous post about Wine I mentioned working on a debugger that is capable of debugging both the Wine layer and the Windows application running with it. Time to share some details!"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-26T15:20:00+01:00"><meta property="article:modified_time" content="2022-10-26T15:20:00+01:00"><meta property="og:image" content="https://werat.dev/blog/debugging-wine-with-lldb-and-vscode/debugging-doggo.png"><link rel=canonical href=https://werat.dev/blog/debugging-wine-with-lldb-and-vscode/><link rel=alternate type=application/rss+xml title=werat.dev href=https://werat.dev/index.xml><link rel=icon href=/favicon.ico sizes=any><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=manifest href=/manifest.webmanifest><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.140.1"></head><body><header class=nav-header><nav><span class=nav-title><a href=/>werat.dev</a>
</span><a href=/about/>About</a>
<a href=/posts/>Blog</a>
<a href=/talks/>Talks</a></nav></header><main><article><header><h1 class=title>Debugging Wine with LLDB and VSCode</h1><time class=posted-on datetime=2022-10-26T15:20:00+01:00>October 26, 2022</time></header><p><img src=debugging-doggo.png alt="DALL-E generated doggo debugging Wine" width=1961 height=856></p><p>In my <a href=/blog/how-wine-works-101/>previous post about Wine</a> I mentioned working on a debugger that is capable of debugging both the Wine layer and the Windows application running with it. Time to share some details!</p><hr><p>Debugging Wine applications is tricky and there are different ways to do it. In many cases you don&rsquo;t have access to the application source code and/or debug symbols and Wine itself is often built with aggressive optimizations. The mixture of Windows and Linux modules makes most debuggers sad and people often resort to <a href=https://www.codeweavers.com/blog/aeikum/2019/1/15/working-on-wine-part-4-debugging-wine>printf-debugging</a>. The official <a href=https://wiki.winehq.org/Wine_Developer%27s_Guide>Wine Developer&rsquo;s Guide</a> has some <a href=https://wiki.winehq.org/Debugging_Hints>Debugging Hints</a> and a whole chapter about <a href=https://wiki.winehq.org/Wine_Developer%27s_Guide/Debugging_Wine>Debugging Wine</a>. It has useful links and examples of using <a href=https://gitlab.winehq.org/wine/wine/-/tree/master/programs/winedbg>winedbg</a> &ndash; a debugger written specifically for Wine. It came a long way and supports lots of features now, but still has limitations.</p><p>In this article I will demonstrate how to use <a href=https://lldb.llvm.org/>LLDB</a> to debug an application running with Wine. We&rsquo;ll step through both the application code (i.e. Windows executable) and the Wine layer (which is mixture of Linux and Windows libraries), set some breakpoints and look at variables and memory. I&rsquo;m going to use a local Windows machine to run the debugger and a remote Linux machine to run the Wine application. The debugger can work on Linux and macOS too, but Windows has better PDB support &ndash; see more below in the section about building LLDB. Also, my workflow involves rebuilding the original executable from source, which needs to happen on Windows.</p><h2 id=demo-time>Demo time!</h2><p>Here&rsquo;s a quick demo of running a command-line LLDB on Windows. It demonstrates connecting to a remote Linux machine, attaching to a Wine process and doing typical debugging things: looking at the call stack, setting breakpoints and stepping, looking at variables and reading memory.</p><p><a href=https://asciinema.org/a/J95lTmBX9FcHtiRREP2wxZUhu><img src=https://asciinema.org/a/J95lTmBX9FcHtiRREP2wxZUhu.svg alt="Debugging Wine with LLDB on Windows"></a></p><p>While I still have your attention, here&rsquo;s a teaser demo of using the same debugger with Visual Studio Code. Here I&rsquo;m using my local Windows machine to debug a native Windows binary running on a remote Linux machine via Wine, isn&rsquo;t that magic? I can step through the code, set breakpoints and look at the variables as if it were a normal local process.</p><p><img src=vscode-teaser.png alt="Visual Studio Code debugging teaser" width=1507 height=1098></p><h2 id=why-cant-it-just-work>Why can&rsquo;t it just work?</h2><p><em>Normally</em> the main executable and its dynamic libraries all have the same formats of object files (e.g. ELF on Linux) and debug info (e.g. PDB on Windows). The debuggers also often make certain assumptions about how the dynamic loader works (remember <code>ld.so</code>?), since there&rsquo;s usually just one. However, certain applications are special and don&rsquo;t fit into this perfect picture&mldr;</p><p>An application running with Wine has two different dynamic loaders and a mixture of ELF/PE modules and DWARF/PDB debug information. Here&rsquo;s a quick overview of the dependencies involved when a Windows binary is executed on a Linux system via Wine, e.g. <code>wine HalfLife4.exe</code>:</p><ul><li><code>wine</code> is a native Linux executable (ELF+DWARF), which is bootstrapped via the <code>ld.so</code> dynamic loader</li><li><code>wine</code> is a dynamic loader itself, which loads the native Windows executable <code>HalfLife4.exe</code> (PE+PDB)</li><li><code>HalfLife4.exe</code> may depend on some native Windows libraries, e.g. <code>GameEngine.dll</code> (PE+PDB)</li><li><code>HalfLife4.exe</code> also depends on certain Windows DLLs, e.g. <code>ntdll.dll</code></li><li><code>ntdll.dll</code> is provided by Wine as a dll/so pair: <code>ntdll.dll</code> (PE+DWARF) + <code>ntdll.so</code> (ELF+DWARF)</li></ul><p>As you can see, the application has a crazy mix of different formats and the debugger needs to handle all these combinations in order to correctly unwind the stack, resolve symbols, set breakpoints and so on. Luckily, LLDB doesn&rsquo;t make an assumption that all modules have the same format. It can handle all possible combinations, as long the data is well-formed.</p><p>One big thing missing at the moment is the support for Wine dynamic loader. Without it LLDB cannot do much. You can still attach to the process (since it&rsquo;s a regular Linux process after all), but the debugger won&rsquo;t be able to resolve the call stack or see any of the loaded modules:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>process</span> <span style=color:#000>attach</span> <span style=color:#000>--</span><span style=color:#000>pid</span> <span style=color:#1c01ce>29354</span>
</span></span><span style=display:flex><span><span style=color:#000>Process</span> <span style=color:#1c01ce>29354</span> <span style=color:#000>stopped</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>bt</span>
</span></span><span style=display:flex><span><span style=color:#000>*</span> <span style=color:#a90d91>thread</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span>, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>&#39;</span><span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>&#39;</span>, <span style=color:#000>stop</span> <span style=color:#000>reason</span> <span style=color:#000>=</span> <span style=color:#000>signal</span> <span style=color:#000>SIGSTOP</span>
</span></span><span style=display:flex><span>  <span style=color:#000>*</span> <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>0</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f1c26939603</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f1c265aa79a</span>
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>target</span> <span style=color:#000>module</span> <span style=color:#000>list</span>
</span></span><span style=display:flex><span>[  <span style=color:#1c01ce>0</span>] <span style=color:#1c01ce>129</span><span style=color:#000>BD624</span><span style=color:#000>-</span><span style=color:#000>C9D6</span><span style=color:#000>-</span><span style=color:#1c01ce>1</span><span style=color:#000>B63</span><span style=color:#000>-</span><span style=color:#1c01ce>8</span><span style=color:#000>C99</span><span style=color:#000>-</span><span style=color:#000>D72D21F0AD2C</span><span style=color:#000>-</span><span style=color:#1c01ce>2</span><span style=color:#000>BECC83D</span> <span style=color:#1c01ce>0x0000000000400000</span> <span style=color:#000>C</span>:<span style=color:#000>\</span><span style=color:#000>Users</span><span style=color:#000>\</span><span style=color:#000>werat</span><span style=color:#000>\</span>.<span style=color:#000>lldb</span><span style=color:#000>\</span><span style=color:#000>module_cache</span><span style=color:#000>\</span><span style=color:#000>remote</span><span style=color:#000>-</span><span style=color:#000>linux</span><span style=color:#000>\</span>.<span style=color:#000>cache</span><span style=color:#000>\</span><span style=color:#1c01ce>129</span><span style=color:#000>BD624</span><span style=color:#000>-</span><span style=color:#000>C9D6</span><span style=color:#000>-</span><span style=color:#1c01ce>1</span><span style=color:#000>B63</span><span style=color:#000>-</span><span style=color:#1c01ce>8</span><span style=color:#000>C99</span><span style=color:#000>-</span><span style=color:#000>D72D21F0AD2C</span><span style=color:#000>-</span><span style=color:#1c01ce>2</span><span style=color:#000>BECC83D</span><span style=color:#000>\</span><span style=color:#000>wine64</span><span style=color:#000>-</span><span style=color:#000>preloader</span>
</span></span><span style=display:flex><span>[  <span style=color:#1c01ce>1</span>] <span style=color:#000>FD79862B</span><span style=color:#000>-</span><span style=color:#000>DC7F</span><span style=color:#000>-</span><span style=color:#1c01ce>5957</span><span style=color:#000>-</span><span style=color:#000>F69B</span><span style=color:#000>-</span><span style=color:#1c01ce>38086</span><span style=color:#000>ECC9EBC</span><span style=color:#000>-</span><span style=color:#1c01ce>9</span><span style=color:#000>DD4538A</span> <span style=color:#1c01ce>0x00007ffc1dce9000</span> [<span style=color:#000>vdso</span>] (<span style=color:#1c01ce>0x00007ffc1dce9000</span>)
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>)
</span></span></code></pre></div><h2 id=lldb--wine--3>LLDB + Wine = &lt;3</h2><p>My teammates and I have put some effort into making LLDB work better with Wine. Some of changes we made have already been merged into upstream LLDB (especially the not-too-wine-specific ones), but others were kept internal. Recently I&rsquo;ve published most of the relevant work &ndash; it&rsquo;s available in <a href=https://github.com/googlestadia/vsi-lldb/tree/master/patches/llvm-project>googlestadia/vsi-lldb</a> repository (or <a href=https://github.com/werat/llvm-project-wine>werat/llvm-project-wine</a> for an easier checkout). These patches can be applied cleanly on the <code>release/14.x</code> branch and <em>may</em> require some merging/rebasing for newer versions of llvm-project.</p><p>The most important change to LLDB is about the dynamic loader support for Wine &ndash; <a href=https://github.com/werat/llvm-project-wine/blob/main/patches/0030-lldb-Add-DYLD-plugin-for-debugging-Wine.patch>Add-DYLD-plugin-for-debugging-Wine</a> by <a href=https://github.com/jaro-sevcik>Jaroslav Sevcik</a>. It enables the debugger to detect and process modules loaded by Wine processes, which is the basic thing it needs to work properly. Maybe this patch will find its way into upstream eventually ðŸ˜ƒ.</p><h3 id=building-lldb>Building LLDB</h3><p>First, we need to build our own version of LLDB with Wine-related patches applied. As I mentioned above, you can get the patches from <a href=https://github.com/werat/llvm-project-wine>werat/llvm-project-wine</a> and they can be applied on <code>release/14.x</code> branch without any conflicts.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#177500># Clone LLDB sources and custom patches for Wine support.</span>
</span></span><span style=display:flex><span>git clone https://github.com/llvm/llvm-project.git --branch release/14.x --single-branch
</span></span><span style=display:flex><span>git clone https://github.com/werat/llvm-project-wine.git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Apply the patches.</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>cd</span> llvm-project
</span></span><span style=display:flex><span>git apply ../llvm-project-wine/patches/*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Build LLDB!</span>
</span></span><span style=display:flex><span><span style=color:#177500># This normally happens in Visual Studio Developer Command Prompt.</span>
</span></span><span style=display:flex><span>mkdir build_optdebug <span style=color:#000>&amp;&amp;</span> <span style=color:#a90d91>cd</span> build_optdebug
</span></span><span style=display:flex><span>cmake -GNinja -DLLVM_ENABLE_PROJECTS<span style=color:#000>=</span><span style=color:#c41a16>&#34;lldb&#34;</span> -DCMAKE_BUILD_TYPE<span style=color:#000>=</span>RelWithDebInfo ../llvm
</span></span><span style=display:flex><span>ninja lldb
</span></span></code></pre></div><p>There&rsquo;s one caveat regarding PDB support. LLDB has two implementations of the PDB parser: <code>NativePDB</code> with no external dependencies and <code>PDB</code> which uses <a href="https://learn.microsoft.com/en-us/visualstudio/debugger/debug-interface-access/debug-interface-access-sdk?view=vs-2022">DIA SDK</a> (and therefore works only on Windows). The &ldquo;native&rdquo; parser works on any platform, but it is still work in progress and is missing lots of features. Its primary focus is post-mortem debugging (i.e. coredumps) and it doesn&rsquo;t work well with real-time debugging yet. The other one is more complete and works reasonably well, but it&rsquo;s a bit slower and supported only on Windows.</p><p>The <code>PDB</code> parser is used by default and the debugger needs to locate <code>msdia140.dll</code>, which is typically installed with Visual Studio, e.g. <code>[VisualStudioFolder]\DIA SDK\bin\msdia140.dll</code>. Either add that to <code>PATH</code> or copy the DLL to the LLDB installation location (i.e. next to the <code>lldb.exe/liblldb.dll</code>). In order to use <code>NativePDB</code> set the environmental variable <code>LLDB_USE_NATIVE_PDB_READER=1</code> when running the debugger.</p><h3 id=using-lldb-in-command-line-mode>Using LLDB in command-line mode</h3><p>Now that we have a debugger, let&rsquo;s try attaching to a simple Windows application running with Wine. In this setup the application is running on a remote Linux machine (which can be a Linux VM running via WSL, for example).</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#a90d91>PS </span><span style=color:#000>D:</span>\&gt; <span style=color:#000>D:</span>\<span style=color:#000>src</span>\<span style=color:#a90d91>llvm-project</span>\<span style=color:#000>build_optdebug</span>\<span style=color:#000>bin</span>\<span style=color:#000>lldb</span>.<span style=color:#000>exe</span>
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>platform</span> <span style=color:#a90d91>select remote-linux</span>
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>platform</span> <span style=color:#000>connect</span> <span style=color:#000>connect</span><span style=color:#000>:</span>//<span style=color:#000>monkey</span>.<span style=color:#000>werat</span>.<span style=color:#000>dev</span><span style=color:#000>:</span><span style=color:#1c01ce>44420</span>
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#a90d91>process</span> <span style=color:#000>attach</span> -<span style=color:#000>-pid</span> <span style=color:#1c01ce>15872</span>  <span style=color:#177500># PID of the Wine application</span>
</span></span></code></pre></div><p>^ this assumes there&rsquo;s an <code>lldb-server</code> running on the remote host</p><p>The attaching may take some time as the debugger needs to download the binaries and resolve the symbols, process them, build up some internal state (e.g. debug information lookup indexes), resolve the breakpoints and so on. LLDB is not very efficient in downloading the binaries over network, but it does have a cache, so subsequent attaches should be much faster. The result of the <code>process attach</code> should look something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#000>Process</span> <span style=color:#1c01ce>15872</span> <span style=color:#000>stopped</span>
</span></span><span style=display:flex><span><span style=color:#000>*</span> <span style=color:#a90d91>thread</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span>, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>&#39;</span><span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>&#39;</span>, <span style=color:#000>stop</span> <span style=color:#000>reason</span> <span style=color:#000>=</span> <span style=color:#000>signal</span> <span style=color:#000>SIGSTOP</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>0</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e2585603</span> <span style=color:#000>libc</span><span style=color:#000>-</span><span style=color:#1c01ce>2.24</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>__select</span> <span style=color:#000>+</span> <span style=color:#1c01ce>51</span>
</span></span><span style=display:flex><span><span style=color:#000>libc</span><span style=color:#000>-</span><span style=color:#1c01ce>2.24</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>__select</span>:
</span></span><span style=display:flex><span><span style=color:#000>-&gt;</span>  <span style=color:#1c01ce>0x7f37e2585603</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>51</span><span style=color:#000>&gt;:</span> <span style=color:#000>movq</span>   (<span style=color:#000>%</span><span style=color:#000>rsp</span>), <span style=color:#000>%</span><span style=color:#000>rdi</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>0x7f37e2585607</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>55</span><span style=color:#000>&gt;:</span> <span style=color:#000>movq</span>   <span style=color:#000>%</span><span style=color:#000>rax</span>, <span style=color:#000>%</span><span style=color:#000>rdx</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>0x7f37e258560a</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>58</span><span style=color:#000>&gt;:</span> <span style=color:#000>callq</span>  <span style=color:#1c01ce>0x7f37e2599560</span>            ; <span style=color:#000>___lldb_unnamed_symbol2935</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>0x7f37e258560f</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>63</span><span style=color:#000>&gt;:</span> <span style=color:#000>movq</span>   <span style=color:#000>%</span><span style=color:#000>rdx</span>, <span style=color:#000>%</span><span style=color:#000>rax</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>thread</span> <span style=color:#000>#</span><span style=color:#1c01ce>2</span>, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>&#39;</span><span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>&#39;</span>, <span style=color:#000>stop</span> <span style=color:#000>reason</span> <span style=color:#000>=</span> <span style=color:#000>signal</span> <span style=color:#000>SIGSTOP</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>0</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e2585603</span> <span style=color:#000>libc</span><span style=color:#000>-</span><span style=color:#1c01ce>2.24</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>__select</span> <span style=color:#000>+</span> <span style=color:#1c01ce>51</span>
</span></span><span style=display:flex><span><span style=color:#000>libc</span><span style=color:#000>-</span><span style=color:#1c01ce>2.24</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>__select</span>:
</span></span><span style=display:flex><span><span style=color:#000>-&gt;</span>  <span style=color:#1c01ce>0x7f37e2585603</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>51</span><span style=color:#000>&gt;:</span> <span style=color:#000>movq</span>   (<span style=color:#000>%</span><span style=color:#000>rsp</span>), <span style=color:#000>%</span><span style=color:#000>rdi</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>0x7f37e2585607</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>55</span><span style=color:#000>&gt;:</span> <span style=color:#000>movq</span>   <span style=color:#000>%</span><span style=color:#000>rax</span>, <span style=color:#000>%</span><span style=color:#000>rdx</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>0x7f37e258560a</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>58</span><span style=color:#000>&gt;:</span> <span style=color:#000>callq</span>  <span style=color:#1c01ce>0x7f37e2599560</span>            ; <span style=color:#000>___lldb_unnamed_symbol2935</span>
</span></span><span style=display:flex><span>    <span style=color:#1c01ce>0x7f37e258560f</span> <span style=color:#000>&lt;+</span><span style=color:#1c01ce>63</span><span style=color:#000>&gt;:</span> <span style=color:#000>movq</span>   <span style=color:#000>%</span><span style=color:#000>rdx</span>, <span style=color:#000>%</span><span style=color:#000>rax</span>
</span></span><span style=display:flex><span><span style=color:#000>Executable</span> <span style=color:#000>module</span> <span style=color:#000>set</span> <span style=color:#000>to</span> <span style=color:#c41a16>&#34;C:\Users\werat\.lldb\module_cache</span><span style=color:#c41a16>\r</span><span style=color:#c41a16>emote-linux\.cache</span><span style=color:#c41a16>\12</span><span style=color:#c41a16>9BD624-C9D6-1B63-8C99-D72D21F0AD2C-2BE</span>
</span></span><span style=display:flex><span><span style=color:#000>CC83D</span><span style=color:#000>\</span><span style=color:#000>wine64</span><span style=color:#000>-</span><span style=color:#000>preloader</span><span style=color:#c41a16>&#34;.</span>
</span></span><span style=display:flex><span><span style=color:#000>Architecture</span> <span style=color:#000>set</span> <span style=color:#000>to</span>: <span style=color:#000>x86_64</span><span style=color:#000>-</span><span style=color:#000>unknown</span><span style=color:#000>-</span><span style=color:#000>linux</span><span style=color:#000>-</span><span style=color:#000>gnu</span>.
</span></span></code></pre></div><p>Here we see that the application has two active threads and both are waiting for something via the <code>__select()</code> function from the standard library. I don&rsquo;t have the source code for <code>libc-2.24.so</code>, so LLDB only shows the disassembly. Let&rsquo;s see what&rsquo;s happening by inspecting the call stack of the current thread:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#a90d91>thread</span> <span style=color:#000>backtrace</span>
</span></span><span style=display:flex><span><span style=color:#000>*</span> <span style=color:#a90d91>thread</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span>, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>&#39;</span><span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>&#39;</span>, <span style=color:#000>stop</span> <span style=color:#000>reason</span> <span style=color:#000>=</span> <span style=color:#000>signal</span> <span style=color:#000>SIGSTOP</span>
</span></span><span style=display:flex><span>  <span style=color:#000>*</span> <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>0</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e2585603</span> <span style=color:#000>libc</span><span style=color:#000>-</span><span style=color:#1c01ce>2.24</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>__select</span> <span style=color:#000>+</span> <span style=color:#1c01ce>51</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e22103b2</span> <span style=color:#000>ntdll</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>NtDelayExecution</span>(<span style=color:#000>alertable</span><span style=color:#000>=</span><span style=color:#2300ce>&#39;\0&#39;</span>, <span style=color:#000>timeout</span><span style=color:#000>=</span><span style=color:#1c01ce>0x000000000011f888</span>) <span style=color:#000>at</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1618</span><span style=color:#000>:</span><span style=color:#1c01ce>17</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>2</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e21f679a</span> <span style=color:#000>ntdll</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>__wine_syscall_dispatcher</span> <span style=color:#000>+</span> <span style=color:#1c01ce>414</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>3</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x000000017000cce4</span> <span style=color:#000>ntdll</span>.<span style=color:#000>dll</span><span style=color:#000>`</span><span style=color:#000>NtDelayExecution</span> <span style=color:#000>+</span> <span style=color:#1c01ce>20</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>4</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000180022ede</span> <span style=color:#000>msvcp140d</span>.<span style=color:#000>dll</span><span style=color:#000>`</span><span style=color:#000>_Thrd_sleep</span> <span style=color:#000>+</span> <span style=color:#1c01ce>62</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>5</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000140002b67</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>void</span> <span style=color:#a90d91>__cdecl</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>this_thread</span><span style=color:#000>::</span><span style=color:#000>sleep_until</span><span style=color:#000>&lt;</span><span style=color:#a90d91>struct</span> <span style=color:#3f6e75>std</span><span style=color:#000>::</span><span style=color:#000>chrono</span><span style=color:#000>::</span><span style=color:#000>steady_clock</span>,<span style=color:#a90d91>class</span> <span style=color:#3f6e75>std</span><span style=color:#000>::</span><span style=color:#000>chrono</span><span style=color:#000>::</span><span style=color:#000>duration</span><span style=color:#000>&lt;</span><span style=color:#a90d91>__int64</span>,<span style=color:#a90d91>struct</span> <span style=color:#3f6e75>std</span><span style=color:#000>::</span><span style=color:#000>ratio</span><span style=color:#000>&lt;</span><span style=color:#1c01ce>1</span>,<span style=color:#1c01ce>1000000000</span><span style=color:#000>&gt;</span> <span style=color:#000>&gt;</span> <span style=color:#000>&gt;</span>(<span style=color:#000>_Abs_time</span><span style=color:#000>=</span><span style=color:#1c01ce>0x000000000011fb48</span>) <span style=color:#000>at</span> <span style=color:#a90d91>thread</span><span style=color:#000>:</span><span style=color:#1c01ce>200</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>6</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000140002aba</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>void</span> <span style=color:#a90d91>__cdecl</span> <span style=color:#000>std</span><span style=color:#000>::</span><span style=color:#000>this_thread</span><span style=color:#000>::</span><span style=color:#000>sleep_for</span><span style=color:#000>&lt;</span><span style=color:#a90d91>__int64</span>,<span style=color:#a90d91>struct</span> <span style=color:#3f6e75>std</span><span style=color:#000>::</span><span style=color:#000>ratio</span><span style=color:#000>&lt;</span><span style=color:#1c01ce>1</span>,<span style=color:#1c01ce>1</span><span style=color:#000>&gt;</span> <span style=color:#000>&gt;</span>(<span style=color:#000>_Rel_time</span><span style=color:#000>=</span><span style=color:#1c01ce>0x000000000011fcc8</span>) <span style=color:#000>at</span> <span style=color:#a90d91>thread</span><span style=color:#000>:</span><span style=color:#1c01ce>206</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>7</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x000000014000362f</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#000>main</span>(<span style=color:#000>argc</span><span style=color:#000>=</span><span style=color:#1c01ce>1</span>, <span style=color:#000>argv</span><span style=color:#000>=</span><span style=color:#1c01ce>0x00000000002c1a20</span>) <span style=color:#000>at</span> <span style=color:#000>main</span>.<span style=color:#000>cc</span>:<span style=color:#1c01ce>120</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>8</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000140003fb9</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>static</span> <span style=color:#a90d91>int</span> <span style=color:#000>invoke_main</span>() <span style=color:#000>at</span> <span style=color:#000>exe_common</span>.<span style=color:#000>inl</span>:<span style=color:#1c01ce>78</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>9</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000140003ede</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>static</span> <span style=color:#a90d91>int</span> <span style=color:#000>__scrt_common_main_seh</span>() <span style=color:#000>at</span> <span style=color:#000>exe_common</span>.<span style=color:#000>inl</span>:<span style=color:#1c01ce>288</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>10</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000140003d9e</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>static</span> <span style=color:#a90d91>int</span> <span style=color:#000>__scrt_common_main</span>() <span style=color:#000>at</span> <span style=color:#000>exe_common</span>.<span style=color:#000>inl</span>:<span style=color:#1c01ce>330</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>11</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x000000014000402e</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#000>mainCRTStartup</span>(<span style=color:#000>__formal</span><span style=color:#000>=</span><span style=color:#1c01ce>0x0000000067ff0000</span>) <span style=color:#000>at</span> <span style=color:#000>exe_main</span>.<span style=color:#000>cpp</span>:<span style=color:#1c01ce>16</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>12</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x000000007b636179</span> <span style=color:#000>kernel32</span>.<span style=color:#000>dll</span><span style=color:#000>`</span><span style=color:#000>BaseThreadInitThunk</span>(<span style=color:#000>unknown</span><span style=color:#000>=</span><span style=color:#1c01ce>0</span>, <span style=color:#000>entry</span><span style=color:#000>=</span>(<span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#000>mainCRTStartup</span> <span style=color:#000>at</span> <span style=color:#000>exe_main</span>.<span style=color:#000>cpp</span>:<span style=color:#1c01ce>15</span>), <span style=color:#000>arg</span><span style=color:#000>=</span><span style=color:#1c01ce>0x0000000067ff0000</span>) <span style=color:#000>at</span> <span style=color:#a90d91>thread</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>61</span><span style=color:#000>:</span><span style=color:#1c01ce>5</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>13</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x0000000170074345</span> <span style=color:#000>ntdll</span>.<span style=color:#000>dll</span><span style=color:#000>`</span><span style=color:#000>RtlUserThreadStart</span>(<span style=color:#000>entry</span><span style=color:#000>=</span>(<span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#000>mainCRTStartup</span> <span style=color:#000>at</span> <span style=color:#000>exe_main</span>.<span style=color:#000>cpp</span>:<span style=color:#1c01ce>15</span>), <span style=color:#000>arg</span><span style=color:#000>=</span><span style=color:#1c01ce>0x0000000067ff0000</span>) <span style=color:#000>at</span> <span style=color:#a90d91>thread</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>265</span><span style=color:#000>:</span><span style=color:#1c01ce>9</span>
</span></span></code></pre></div><p>Now we&rsquo;re talking! It&rsquo;s clear now that the application is sleeping via <code>std::this_thread::sleep_for()</code> from the C++ standard library. We can see how the execution goes through different layers:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>HalfLife4.exe                   -- PE/PDB
</span></span><span style=display:flex><span> \ msvcp140d.dll                -- PE/PDB (Wine has non-debug msvcp140.dll, which is PE/DWARF)
</span></span><span style=display:flex><span>  \ ntdll.dll                   -- PE/DWARF
</span></span><span style=display:flex><span>   \ __wine_syscall_dispatcher  -- technically ELF/DWARF, written in ASM with manual CFI info
</span></span><span style=display:flex><span>    \ ntdll.so                  -- ELF/DWARF
</span></span><span style=display:flex><span>     \ libc-2.24.so             -- ELF/DWARF
</span></span></code></pre></div><p>The application was built in debug mode, so it depends on the debug versions of the standard library &ndash; i.e. <code>msvcp140d.dll</code> instead of <code>msvcp140.dll</code>. Wine has release versions of these DLLs, but the debug ones should be provided by the user. In this case I just copied over the original Windows DLL and it works.</p><hr><p>If your call stack abruptly stops at <code>__wine_syscall_dispatcher</code> make sure your Wine is built with this patch &ndash; <a href=https://gitlab.winehq.org/wine/wine/-/merge_requests/1065>https://gitlab.winehq.org/wine/wine/-/merge_requests/1065</a> by <a href=https://github.com/florian-kuebler>florian-kuebler</a>. The syscall dispatcher function is written in pure assembly (<a href=https://gitlab.winehq.org/wine/wine/-/blob/e72a16b57f66b63a16bb3d1619ac4d42632cb141/dlls/ntdll/unix/signal_x86_64.c#L3351>src</a>) and manually manipulates the registers and changes the stack layout. The compiler is not able to automatically generate the unwind information and that&rsquo;s why the debugger cannot reconstruct the call stack. Florian&rsquo;s patch adds the CFI (Call Frame Information) entries which tell the compiler how the unwind information should look like. For more info about CFI see <a href=https://www.imperialviolet.org/2017/01/18/cfi.html>CFI directives in assembly files</a>.</p><hr><p>Let&rsquo;s try switching to the frame with <code>ntdll.so!NtDelayExecution</code> and see what&rsquo;s happening there:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>frame</span> <span style=color:#000>select</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span><span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e22103b2</span> <span style=color:#000>ntdll</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>NtDelayExecution</span>(
</span></span><span style=display:flex><span>    <span style=color:#000>alertable</span><span style=color:#000>=</span><span style=color:#2300ce>&#39;\0&#39;</span>, <span style=color:#000>timeout</span><span style=color:#000>=</span><span style=color:#1c01ce>0x000000000011f888</span>) <span style=color:#000>at</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1618</span><span style=color:#000>:</span><span style=color:#1c01ce>17</span>
</span></span></code></pre></div><p>At this point the debugger would normally print the source code and point to the current line. We can see that LLDB successfully loaded the debug information and it does know the correct file and line/column &ndash; it&rsquo;s <code>sync.c:1618:17</code>. However it couldn&rsquo;t open the file, because the debug information likely contains the <em>original</em> path, i.e. the path on the build machine. We can easily verify that:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>image</span> <span style=color:#000>lookup</span> <span style=color:#000>-</span><span style=color:#000>vn</span> <span style=color:#000>NtDelayExecution</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#1c01ce>1</span> <span style=color:#000>match</span> <span style=color:#000>found</span> <span style=color:#000>in</span> <span style=color:#000>C</span>:<span style=color:#000>\</span><span style=color:#000>Users</span><span style=color:#000>\</span><span style=color:#000>werat</span><span style=color:#000>\</span>.<span style=color:#000>lldb</span><span style=color:#000>\</span><span style=color:#000>module_cache</span><span style=color:#000>\</span><span style=color:#000>remote</span><span style=color:#000>-</span><span style=color:#000>linux</span><span style=color:#000>\</span>.<span style=color:#000>cache</span><span style=color:#000>\</span><span style=color:#1c01ce>91</span><span style=color:#000>CE2715</span><span style=color:#000>-</span><span style=color:#1c01ce>98</span><span style=color:#000>C9</span><span style=color:#000>-</span><span style=color:#1c01ce>69</span><span style=color:#000>EA</span><span style=color:#000>-</span><span style=color:#000>B6E5</span><span style=color:#000>-</span><span style=color:#000>BE8E1DA4A196</span><span style=color:#000>-</span><span style=color:#1c01ce>5</span><span style=color:#000>B46395A</span><span style=color:#000>\</span><span style=color:#000>ntdll</span>.<span style=color:#000>so</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>Address</span>: <span style=color:#000>ntdll</span>.<span style=color:#000>so</span>[<span style=color:#1c01ce>0x000000000007f170</span>] (<span style=color:#000>ntdll</span>.<span style=color:#000>so</span>.<span style=color:#000>PT_LOAD</span>[<span style=color:#1c01ce>0</span>]..<span style=color:#000>text</span> <span style=color:#000>+</span> <span style=color:#1c01ce>472384</span>)
</span></span><span style=display:flex><span>        <span style=color:#000>Summary</span>: <span style=color:#000>ntdll</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>NtDelayExecution</span> <span style=color:#000>at</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1570</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Module</span>: <span style=color:#000>file</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;C:\Users\werat\.lldb\module_cache</span><span style=color:#c41a16>\r</span><span style=color:#c41a16>emote-linux\.cache\91CE2715-98C9-69EA-B6E5-BE8E1DA4A196-5B46395A</span><span style=color:#c41a16>\n</span><span style=color:#c41a16>tdll.so&#34;</span>, <span style=color:#000>arch</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;x86_64&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>CompileUnit</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x0000000f</span>}, <span style=color:#000>file</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;/workspace/src/project/third_party/proton-wine/dlls/ntdll/unix/sync.c&#34;</span>, <span style=color:#000>language</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;c99&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Function</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x000c9aa3</span>}, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;NtDelayExecution&#34;</span>, <span style=color:#000>range</span> <span style=color:#000>=</span> [<span style=color:#1c01ce>0x00007f37e2210170</span><span style=color:#000>-</span><span style=color:#1c01ce>0x00007f37e2210417</span>)
</span></span><span style=display:flex><span>       <span style=color:#000>FuncType</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x000c9aa3</span>}, <span style=color:#000>byte</span><span style=color:#000>-</span><span style=color:#000>size</span> <span style=color:#000>=</span> <span style=color:#1c01ce>0</span>, <span style=color:#000>decl</span> <span style=color:#000>=</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1569</span>, <span style=color:#000>compiler_type</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;NTSTATUS (BOOLEAN, const LARGE_INTEGER *) __attribute__((ms_abi))&#34;</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Blocks</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x000c9aa3</span>}, <span style=color:#000>range</span> <span style=color:#000>=</span> [<span style=color:#1c01ce>0x7f37e2210170</span><span style=color:#000>-</span><span style=color:#1c01ce>0x7f37e2210417</span>)
</span></span><span style=display:flex><span>      <span style=color:#000>LineEntry</span>: [<span style=color:#1c01ce>0x00007f37e2210170</span><span style=color:#000>-</span><span style=color:#1c01ce>0x00007f37e22101c3</span>)<span style=color:#000>:</span> <span style=color:#000>/</span><span style=color:#000>workspace</span><span style=color:#000>/</span><span style=color:#000>src</span><span style=color:#000>/</span><span style=color:#000>project</span><span style=color:#000>/</span><span style=color:#000>third_party</span><span style=color:#000>/</span><span style=color:#000>proton</span><span style=color:#000>-</span><span style=color:#000>wine</span><span style=color:#000>/</span><span style=color:#000>dlls</span><span style=color:#000>/</span><span style=color:#000>ntdll</span><span style=color:#000>/</span><span style=color:#000>unix</span><span style=color:#000>/</span><span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1570</span>
</span></span><span style=display:flex><span>         <span style=color:#000>Symbol</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x00000890</span>}, <span style=color:#000>range</span> <span style=color:#000>=</span> [<span style=color:#1c01ce>0x00007f37e2210170</span><span style=color:#000>-</span><span style=color:#1c01ce>0x00007f37e2210417</span>), <span style=color:#000>name</span><span style=color:#000>=</span><span style=color:#c41a16>&#34;NtDelayExecution&#34;</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Variable</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x000c9abe</span>}, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;alertable&#34;</span>, <span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;BOOLEAN&#34;</span>, <span style=color:#000>location</span> <span style=color:#000>=</span> <span style=color:#000>DW_OP_breg7</span> <span style=color:#000>RSP</span><span style=color:#000>+</span><span style=color:#1c01ce>123</span>, <span style=color:#000>decl</span> <span style=color:#000>=</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1569</span>
</span></span><span style=display:flex><span>       <span style=color:#000>Variable</span>: <span style=color:#000>id</span> <span style=color:#000>=</span> {<span style=color:#1c01ce>0x000c9ace</span>}, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;timeout&#34;</span>, <span style=color:#000>type</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;const LARGE_INTEGER *&#34;</span>, <span style=color:#000>location</span> <span style=color:#000>=</span> <span style=color:#000>DW_OP_breg7</span> <span style=color:#000>RSP</span><span style=color:#000>+</span><span style=color:#1c01ce>112</span>, <span style=color:#000>decl</span> <span style=color:#000>=</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1569</span>
</span></span></code></pre></div><p>Yep, CompileUnit refers to <code>/workspace/src/project/third_party/proton-wine/dlls/ntdll/unix/sync.c</code>, which definitely looks like an absolute file path on the machine where Wine was built. Luckily we can tell the debugger to &ldquo;map&rdquo; certain sources to a different location, so that it can find them locally. In LLDB this is done by setting the <code>target.source-map</code> property:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>settings</span> <span style=color:#a90d91>set </span><span style=color:#000>target</span>.<span style=color:#a90d91>source-map</span> /<span style=color:#000>workspace</span>/<span style=color:#000>src</span>/<span style=color:#000>project</span>/ <span style=color:#000>D:</span>\<span style=color:#000>src</span>\<span style=color:#000>project</span>\
</span></span></code></pre></div><p>Now the debugger will look for <code>D:\src\project\third_party/proton-wine/dlls/ntdll/unix/sync.c</code>. Don&rsquo;t mind the mess with the slashes, it will figure it out. Let&rsquo;s verify:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>frame</span> <span style=color:#000>select</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span><span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00007f37e22103b2</span> <span style=color:#000>ntdll</span>.<span style=color:#000>so</span><span style=color:#000>`</span><span style=color:#000>NtDelayExecution</span>(<span style=color:#000>alertable</span><span style=color:#000>=</span><span style=color:#2300ce>&#39;\0&#39;</span>, <span style=color:#000>timeout</span><span style=color:#000>=</span><span style=color:#1c01ce>0x000000000011f888</span>) <span style=color:#000>at</span> <span style=color:#000>sync</span>.<span style=color:#000>c</span>:<span style=color:#1c01ce>1618</span><span style=color:#000>:</span><span style=color:#1c01ce>17</span>
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>1615</span>             <span style=color:#a90d91>if</span> (<span style=color:#000>diff</span> <span style=color:#000>&lt;=</span> <span style=color:#1c01ce>0</span>) <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>1616</span>             <span style=color:#000>tv</span>.<span style=color:#000>tv_sec</span>  <span style=color:#000>=</span> <span style=color:#000>diff</span> <span style=color:#000>/</span> <span style=color:#1c01ce>1000000</span>;
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>1617</span>             <span style=color:#000>tv</span>.<span style=color:#000>tv_usec</span> <span style=color:#000>=</span> <span style=color:#000>diff</span> <span style=color:#000>%</span> <span style=color:#1c01ce>1000000</span>;
</span></span><span style=display:flex><span><span style=color:#000>-&gt;</span> <span style=color:#1c01ce>1618</span>             <span style=color:#a90d91>if</span> (<span style=color:#000>select</span>( <span style=color:#1c01ce>0</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#a90d91>NULL</span>, <span style=color:#000>&amp;</span><span style=color:#000>tv</span> ) <span style=color:#000>!=</span> <span style=color:#000>-</span><span style=color:#1c01ce>1</span>) <span style=color:#a90d91>break</span>;
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>1619</span>         }
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>1620</span>     }
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>1621</span>     <span style=color:#a90d91>return</span> <span style=color:#000>STATUS_SUCCESS</span>;
</span></span></code></pre></div><p>Cool, isn&rsquo;t it? Now let&rsquo;s go into the Windows-side of the execution. We will set a breakpoint on <code>Game::update()</code> and then let the process stop there:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>b</span> <span style=color:#000>update</span>
</span></span><span style=display:flex><span><span style=color:#000>Breakpoint</span> <span style=color:#1c01ce>1</span><span style=color:#000>:</span> <span style=color:#000>where</span> <span style=color:#000>=</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>public</span><span style=color:#000>:</span> <span style=color:#a90d91>void</span> <span style=color:#a90d91>__cdecl</span> <span style=color:#000>Game</span><span style=color:#000>::</span><span style=color:#000>update</span>(<span style=color:#a90d91>void</span>) <span style=color:#000>+</span> <span style=color:#1c01ce>19</span> <span style=color:#000>at</span> <span style=color:#000>main</span>.<span style=color:#000>cc</span>:<span style=color:#1c01ce>15732480</span>, <span style=color:#000>address</span> <span style=color:#000>=</span> <span style=color:#1c01ce>0x00000001400034b3</span>
</span></span><span style=display:flex><span>(<span style=color:#000>lldb</span>) <span style=color:#000>c</span>
</span></span><span style=display:flex><span><span style=color:#000>Process</span> <span style=color:#1c01ce>15872</span> <span style=color:#000>stopped</span>
</span></span><span style=display:flex><span><span style=color:#000>*</span> <span style=color:#a90d91>thread</span> <span style=color:#000>#</span><span style=color:#1c01ce>1</span>, <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>&#39;</span><span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>&#39;</span>, <span style=color:#000>stop</span> <span style=color:#000>reason</span> <span style=color:#000>=</span> <span style=color:#000>step</span> <span style=color:#000>over</span>
</span></span><span style=display:flex><span>    <span style=color:#000>frame</span> <span style=color:#000>#</span><span style=color:#1c01ce>0</span><span style=color:#000>:</span> <span style=color:#1c01ce>0x00000001400034bf</span> <span style=color:#000>HalfLife4</span>.<span style=color:#000>exe</span><span style=color:#000>`</span><span style=color:#a90d91>public</span><span style=color:#000>:</span> <span style=color:#a90d91>void</span> <span style=color:#a90d91>__cdecl</span> <span style=color:#000>Game</span><span style=color:#000>::</span><span style=color:#000>update</span>(<span style=color:#a90d91>this</span><span style=color:#000>=</span><span style=color:#1c01ce>0x000000000011fbd8</span>) <span style=color:#000>at</span> <span style=color:#000>main</span>.<span style=color:#000>cc</span>:<span style=color:#1c01ce>96</span>
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>93</span>       <span style=color:#000>SYSTEMTIME</span> <span style=color:#000>st</span>;
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>94</span>
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>95</span>       <span style=color:#a90d91>void</span> <span style=color:#000>update</span>() {
</span></span><span style=display:flex><span><span style=color:#000>-&gt;</span> <span style=color:#1c01ce>96</span>           <span style=color:#000>GetSystemTime</span>(<span style=color:#000>&amp;</span><span style=color:#000>st</span>);
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>97</span>       }
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>98</span>
</span></span><span style=display:flex><span>   <span style=color:#1c01ce>99</span>       <span style=color:#a90d91>void</span> <span style=color:#000>render</span>() {
</span></span></code></pre></div><p>Yay, it works! ðŸŽ‰</p><h3 id=using-visual-studio-code>Using Visual Studio Code</h3><p>Using command-line is nice and familiar, but the debugging tech is not standing still. Visual Studio Code is quite popular these days and it has a builtin <a href=https://code.visualstudio.com/Docs/editor/debugging>debugging support</a>. It integrates natively with the <a href=https://microsoft.github.io/debug-adapter-protocol/>Debug Adapter Protocol</a> (DAP), which allows plugging in third-party debuggers with minimal effort.</p><p>The easiest way to use LLDB with Visual Studio Code is via the <a href="https://marketplace.visualstudio.com/items?itemName=vadimcn.vscode-lldb">CodeLLDB</a> extension. CodeLLDB comes with its own version of LLDB, but it&rsquo;s possible <a href=https://github.com/vadimcn/vscode-lldb/blob/fe1fb617b273d846b76ba75087e7f35232c9bd9e/MANUAL.md#alternate-lldb-backends>to use custom builds</a>. All you need to do is specify the path to <code>liblldb.dll/so</code> via the <code>lldb.library</code> key in the User or Workspace JSON settings:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;lldb.library&#34;</span>: <span style=color:#c41a16>&#34;D:\\src\\llvm-project-wine\\build_optdebug\\bin\\liblldb.dll&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>LLDB also has its own implementation of the debug adapter &ndash; <a href=https://github.com/llvm/llvm-project/tree/main/lldb/tools/lldb-vscode>lldb-vscode</a>. However it supports fewer features and requires a couple of manual steps to set up with Visual Studio Code.</p></blockquote><p>For attaching to a remote process we need a <a href=https://code.visualstudio.com/Docs/editor/debugging#_launchjson-attributes>debugger launch configuration</a>, also see the <a href=https://github.com/vadimcn/vscode-lldb/blob/fe1fb617b273d846b76ba75087e7f35232c9bd9e/MANUAL.md#remote-debugging>Remote debugging</a> section in the CodeLLDB documentation. In my case the configuration is pretty simple &ndash; declare the source mapping, connect to the remote machine and attach to the process:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;name&#34;</span>: <span style=color:#c41a16>&#34;Remote Attach&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;type&#34;</span>: <span style=color:#c41a16>&#34;lldb&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;request&#34;</span>: <span style=color:#c41a16>&#34;attach&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;initCommands&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;platform select remote-linux&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#c41a16>&#34;platform connect connect://&lt;host&gt;:&lt;port&gt;&#34;</span>,
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;pid&#34;</span>: <span style=color:#1c01ce>12345</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;sourceMap&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;/workspace/src/project/&#34;</span>: <span style=color:#c41a16>&#34;D:\\src\\project\\&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>^ this assumes there&rsquo;s an <code>lldb-server</code> running on the remote machine and Wine process ID is <code>12345</code>.</p><p>Now you can go to the &ldquo;Run and Debug&rdquo; panel and select &ldquo;Remote Attach&rdquo; debug configuration. Click run and wait! Upon the attach you&rsquo;ll see something like this:</p><p><img src=vscode-1.png alt="Visual Studio Code after attaching" width=1507 height=1098></p><p>Here&rsquo;s another example, demonstrating stepping through the Wine code when doing a syscall (<code>NtWriteFile</code>):</p><p><img src=vscode-5.png alt="Visual Studio Code inside the syscall" width=1507 height=1098></p><p>CodeLLDB supports <a href=https://github.com/vadimcn/vscode-lldb/blob/master/MANUAL.md#formatting>various variable formats</a> and makes it easier to inspect the data. In the example above <code>buffer</code> is a void pointer, but you can print its value as a C-string via <code>buffer,s</code>.</p><h2 id=other-ways-to-debug-wine>Other ways to debug Wine</h2><p>As I mentioned in the beginning, using winedbg is an option. It can be run as a gdb-server, so any compatible debugger (like GDB or LLDB) can be used as a frontend. However, depending on the platform and the frontend, certain things may not work properly (e.g. PDB support).</p><p>It&rsquo;s possible to use GDB directly too, here&rsquo;s an example &ndash; <a href=https://trofi.github.io/posts/221-debugging-wine.html>https://trofi.github.io/posts/221-debugging-wine.html</a>. There is also a <a href=https://github.com/JuliaComputing/gdb-solib-wine>GDB fork</a> from JuliaComputing with some Wine-related improvements. It is primarily intended for situations where winedbg cannot be used, e.g. in <a href=https://rr-project.org/>rr</a> traces, but it can be used for regular real-time debugging too.</p><p>Happy ðŸ· debugging!</p><hr><p>Discuss this article on <a href=https://lobste.rs/s/g2swg7/debugging_wine_with_lldb_vscode>lobste.rs</a> or <a href="https://news.ycombinator.com/item?id=33345561">HackerNews</a> or <a href=https://www.reddit.com/r/programming/comments/ye3j7h/debugging_wine_with_lldb_and_vscode/>Reddit</a></p><hr></article></main><footer>Â© 2017 - 2024 <a href=mailto:weratt@gmail.com>Andy Hippo</a>
(<a href=https://twitter.com/werat>@werat</a>)
Â· Licensed under <a href=https://github.com/werat/werat.github.io/blob/main/LICENSE>MIT</a></footer><script data-goatcounter=https://werat-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>