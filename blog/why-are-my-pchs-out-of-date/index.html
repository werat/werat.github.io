<!doctype html><html lang=en><head><title>Why are my PCHs out of date?</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Andy Hippo"><meta name=description content="Last week I got an interesting bug report from a colleague. They were minding their own business and playing with Unreal Engine 5 when suddenly a wild build error appeared and said that some precompiled headers are out of date:
fatal error: file 'D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h' has been modified since the precompiled header 'UE5\Engine\...\SharedPCH.CoreUObject.ShadowErrors.h.gch' was built: mtime changed Hmm, well, it looks like some source files have changed and a simple re-build would fix the issue."><meta name=keywords content="blog,developer,personal,unreal engine,clang,msi,windows installer,windows"><meta name=twitter:card content="summary"><meta name=twitter:title content="Why are my PCHs out of date?"><meta name=twitter:description content="Last week I got an interesting bug report from a colleague. They were minding their own business and playing with Unreal Engine 5 when suddenly a wild build error appeared and said that some precompiled headers are out of date:
fatal error: file 'D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h' has been modified since the precompiled header 'UE5\Engine\...\SharedPCH.CoreUObject.ShadowErrors.h.gch' was built: mtime changed Hmm, well, it looks like some source files have changed and a simple re-build would fix the issue."><meta property="og:title" content="Why are my PCHs out of date?"><meta property="og:description" content="Last week I got an interesting bug report from a colleague. They were minding their own business and playing with Unreal Engine 5 when suddenly a wild build error appeared and said that some precompiled headers are out of date:
fatal error: file 'D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h' has been modified since the precompiled header 'UE5\Engine\...\SharedPCH.CoreUObject.ShadowErrors.h.gch' was built: mtime changed Hmm, well, it looks like some source files have changed and a simple re-build would fix the issue."><meta property="og:type" content="article"><meta property="og:url" content="https://werat.dev/blog/why-are-my-pchs-out-of-date/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-04T13:35:00+01:00"><meta property="article:modified_time" content="2021-12-04T13:35:00+01:00"><link rel=canonical href=https://werat.dev/blog/why-are-my-pchs-out-of-date/><link rel=icon type=image/png href=/img/logo-avatar-32.png sizes=32x32><link rel=icon type=image/png href=/img/logo-avatar-16.png sizes=16x16><link rel=stylesheet href=/css/main.css><meta name=generator content="Hugo 0.109.0"></head><body><header class=nav-header><nav><a class=nav-title href=/>werat.dev</a>
<a href=/posts/>Blog</a>
<a href=/talks/>Talks</a></nav></header><main><section class="container post"><article><header><h1 class=title><a href=https://werat.dev/blog/why-are-my-pchs-out-of-date/>Why are my PCHs out of date?</a></h1><div class=post-meta><div class=date><span class=posted-on><div class=feather-icon><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><time datetime=2021-12-04T13:35:00+01:00>December 4, 2021</time></span></div><div class=tags><div class=feather-icon><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></div><span class=tag><a href=/tags/unreal-engine/>unreal engine</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/clang/>clang</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/msi/>msi</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/windows-installer/>windows installer</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/windows/>windows</a></span></div></div></header><p>Last week I got an interesting bug report from a colleague. They were minding their own business and playing with Unreal Engine 5 when suddenly a wild build error appeared and said that some precompiled headers are out of date:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fatal error: file <span style=color:#4070a0>&#39;D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h&#39;</span> has been
</span></span><span style=display:flex><span>modified since the precompiled header <span style=color:#4070a0>&#39;UE5\Engine\...\SharedPCH.CoreUObject.ShadowErrors.h.gch&#39;</span>
</span></span><span style=display:flex><span>was built: mtime changed
</span></span></code></pre></div><p>Hmm, well, it looks like some source files have changed and a simple re-build would fix the issue. However, building Unreal Engine from scratch takes <strong>considerable</strong> time, so you can understand why we&rsquo;d like to avoid that.</p><p>The toolchain and the sysroot are distributed via the SDK™ and the colleague claimed that the error happened after they&rsquo;ve installed a new version of the SDK. I was fairly sure that the above mentioned header files didn&rsquo;t actually change &ndash; it&rsquo;s a toolchain sysroot, it hasn&rsquo;t been touched in years. Indeed, a simple <code>stat</code> shows that the modification time goes back to 2018:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>&gt; stat <span style=color:#4070a0>&#34;D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h&#34;</span>
</span></span><span style=display:flex><span>  File<span>:</span> D:\toolchain\sysroot\usr\include\<span style=color:#007020>x86_64-linux</span>-gnu\bits\wordsize.<span style=color:#007020>h
</span></span></span><span style=display:flex><span><span style=color:#007020></span>  Size<span>:</span> <span style=color:#40a070>327</span>             Blocks<span>:</span> <span style=color:#40a070>1</span>          IO Block<span>:</span> <span style=color:#40a070>65536</span>  regular file
</span></span><span style=display:flex><span>Device<span>:</span> eab6ee59h/<span style=color:#40a070>3937857113d</span>   Inode<span>:</span> <span style=color:#40a070>8162774325601647</span>  Links<span>:</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>Access<span>:</span> (<span style=color:#40a070>0644</span>/-rw-r--r--)  Uid<span>:</span> (<span style=color:#40a070>2249065</span>/   werat)   Gid<span>:</span> (<span style=color:#40a070>1049089</span>/ UNKNOWN)
</span></span><span style=display:flex><span>Access<span>:</span> <span style=color:#40a070>2021</span>-<span style=color:#40a070>12</span>-<span style=color:#40a070>02</span> <span style=color:#40a070>13</span><span>:</span><span style=color:#40a070>58</span><span>:</span><span style=color:#40a070>10.281221500</span> <span style=color:#40a070>+0100</span>
</span></span><span style=display:flex><span>Modify<span>:</span> <span style=color:#40a070>2018</span>-<span style=color:#40a070>01</span>-<span style=color:#40a070>14</span> <span style=color:#40a070>10</span><span>:</span><span style=color:#40a070>39</span><span>:</span><span style=color:#40a070>44.000000000</span> <span style=color:#40a070>+0100</span>  <span style=color:#60a0b0;font-style:italic># Note: 2018-01-14 09:39:44 UTC</span>
</span></span><span style=display:flex><span>Change<span>:</span> <span style=color:#40a070>2021</span>-<span style=color:#40a070>12</span>-<span style=color:#40a070>02</span> <span style=color:#40a070>13</span><span>:</span><span style=color:#40a070>58</span><span>:</span><span style=color:#40a070>10.281221500</span> <span style=color:#40a070>+0100</span>
</span></span><span style=display:flex><span> Birth<span>:</span> <span style=color:#40a070>2018</span>-<span style=color:#40a070>01</span>-<span style=color:#40a070>14</span> <span style=color:#40a070>10</span><span>:</span><span style=color:#40a070>39</span><span>:</span><span style=color:#40a070>44.000000000</span> <span style=color:#40a070>+0100</span>
</span></span></code></pre></div><p>But surprisingly right after I installed the new SDK, I was getting the same build error too. Oh boy, this is going to be interesting. Down to the rabbit hole!</p><p><img src=quick-adventure.jpg alt="quick adventure meme" width=987 height=1060 style=max-width:500px></p><hr><p>The error we&rsquo;re seeing when building Unreal is coming from <code>clang</code> &ndash; the compiler complains that some of the input files of the precompiled header have been modified (i.e. their <code>mtime</code> is different from what is stored in the PCH). Let&rsquo;s peek inside the the PCH and see whether they are actually different:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># Dump the contents of the PCH (https://clang.llvm.org/docs/PCHInternals.html#ast-file-contents)</span>
</span></span><span style=display:flex><span><span style=color:#007020>llvm-bcanalyzer</span>.exe <span style=color:#4070a0>&#34;UE5\Engine\...\SharedPCH.CoreUObject.ShadowErrors.h.gch&#34;</span> --dump | less
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>&lt;INPUT_FILE abbrevid=<span style=color:#40a070>4</span> op0=<span style=color:#40a070>472</span> op1=<span style=color:#40a070>327</span> op2=<span style=color:#40a070>1515919184</span> op3=<span style=color:#40a070>0</span> op4=<span style=color:#40a070>0</span> op5=<span style=color:#40a070>0</span>/&gt; blob data = <span style=color:#4070a0>&#39;D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h&#39;</span>
</span></span></code></pre></div><p>It&rsquo;s size is <code>327</code> bytes (op1), and modification time is <code>1515919184</code> (op2), which corresponds to <code>2018-01-14 08:39:44 UTC</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>&gt;&gt;</span> <span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>datetime</span> <span style=color:#007020;font-weight:700>import</span> datetime, timezone
</span></span><span style=display:flex><span><span style=color:#666>&gt;&gt;</span> datetime<span style=color:#666>.</span>fromtimestamp(<span style=color:#40a070>1515919184</span>, tz<span style=color:#666>=</span>timezone<span style=color:#666>.</span>utc)
</span></span><span style=display:flex><span>datetime<span style=color:#666>.</span>datetime(<span style=color:#40a070>2018</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>14</span>, <span style=color:#40a070>8</span>, <span style=color:#40a070>39</span>, <span style=color:#40a070>44</span>, tzinfo<span style=color:#666>=</span>datetime<span style=color:#666>.</span>timezone<span style=color:#666>.</span>utc)
</span></span></code></pre></div><p>To summarize what we know so far:</p><ul><li><strong>wordsize.h (from PCH)</strong><ul><li>size &ndash; 327 bytes</li><li>mtime &ndash; 1515919184 (<code>2018-01-14 08:39:44 +0000</code>)</li></ul></li><li><strong>wordsize.h (on disk)</strong><ul><li>size &ndash; 327 bytes</li><li>mtime &ndash; 1515922784 (<code>2018-01-14 09:39:44 +0000</code>)</li></ul></li></ul><p>The file size matches as well as the contents, I&rsquo;ve checked separately. The source files used to build the precompiled header appear to be exactly the same, no <em>real</em> modifications has been made to them. However the <code>mtime</code> is indeed different (the compiler didn&rsquo;t lie).</p><p>Well, I did install a newer version of the SDK recently. The sysroot headers obviously didn&rsquo;t change &ndash; we can see they&rsquo;re are the same. Maybe the <code>mtime</code> got messed up in the newer SDK? Nope, I&rsquo;ve tried installing several different versions, but <code>mtime</code> of that file was always the same.</p><p>It&rsquo;s curious though that the timestamps are different by exactly one hour. When two timestamps are different by exactly N hours programmers usually get real suspicious&mldr;</p><p><img src=its-always-you-three.jpg alt="its always you three meme" width=485 height=433 style=max-width:500px></p><hr><p>The SDK is distributed via the Windows Installer (MSI). And it turns out, Windows Installer adjusts the modification time of the files according to the local timezone of the target machine! It means that the actual file <code>mtime</code> will be different on different machines depending on their timezone, for example:</p><ul><li>Build server has UTC+0, the <code>mtime</code> of <code>wordsize.h</code> is <code>2018-01-14 10:00:00</code>.</li><li>Developer machine has UTC+1, the <code>mtime</code> of <code>wordsize.h</code> is <code>2018-01-14 09:00:00</code> (!!).</li></ul><p>Windows Explorer and other tools (e.g. <code>stat</code>) always display the local time, so both build server and the developer machine will show <code>2018-01-14 10:00:00</code>, but with a different offset, of course. However Windows Explorer doesn&rsquo;t show offsets or timezone, so for the user will just see the same modification time on both machines.</p><p>Same files, same installer, but the <code>mtime</code> will be different depending on your local timezone:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># Let&#39;s say we&#39;re in Berlin, UTC+1</span>
</span></span><span style=display:flex><span>&gt; stat <span style=color:#4070a0>&#34;D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h&#34;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Modify<span>:</span> <span style=color:#40a070>2018</span>-<span style=color:#40a070>01</span>-<span style=color:#40a070>14</span> <span style=color:#40a070>10</span><span>:</span><span style=color:#40a070>39</span><span>:</span><span style=color:#40a070>44.000000000</span> <span style=color:#40a070>+0100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># Aaaand now we&#39;re in Moscow, UTC+3</span>
</span></span><span style=display:flex><span>&gt; stat <span style=color:#4070a0>&#34;D:\toolchain\sysroot\usr\include\x86_64-linux-gnu\bits\wordsize.h&#34;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Modify<span>:</span> <span style=color:#40a070>2018</span>-<span style=color:#40a070>01</span>-<span style=color:#40a070>14</span> <span style=color:#40a070>10</span><span>:</span><span style=color:#40a070>39</span><span>:</span><span style=color:#40a070>44.000000000</span> <span style=color:#40a070>+0300</span>
</span></span></code></pre></div><p>Typically this wouldn&rsquo;t cause an issue &ndash; if local time is always the same, the timestamp will match. But wait-a-minute&mldr; what about the <strong>Daylight Saving Time</strong>? It changes the timezone offset and the files installed after the DST will have different <code>mtime</code> compared to the files installed before the DST.</p><p>I don&rsquo;t know whether it&rsquo;s a bug or a feature, but my guess it&rsquo;s unlikely to be fixed anytime soon because backwards compatibility™. And that means that twice a year our users might need to rebuild their code just because. That&rsquo;s why we can&rsquo;t have nice things ¯\_(ツ)_/¯</p><p>Unfortunately I haven&rsquo;t found a good way to alter this behaviour. <a href="https://www.advancedinstaller.com/forums/viewtopic.php?t=45880">Other people ran into this problem as well</a>, but no solutions have been posted. It&rsquo;s certainly possible to add a custom step to the installer to walk over the files and &ldquo;correct&rdquo; their <code>mtime</code>, but who knows what else might break because of this. If you know a better way, please, send help!</p><hr><p>Discuss this article on <a href=https://lobste.rs/s/qisivk/why_are_my_pchs_out_date>lobste.rs</a></p><hr></article></section></main><footer>© 2017 - 2023 Andy Hippo
· Licensed under <a href=https://github.com/werat/werat.github.io/blob/main/LICENSE>MIT</a></footer><script data-goatcounter=https://werat-dev.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>